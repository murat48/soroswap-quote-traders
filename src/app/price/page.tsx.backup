/* eslint-disable @typescript-eslint/no-explicit-any */
'use client';

import React, { useEffect, useState, useCallback, useRef } from 'react';
import { usePriceTracker } from '@/hooks/use-price-trackernew';
import { PriceDisplay } from '@/components/price-tracker/price-display';
import { Button } from '@/components/ui/button';
import { Card } from '@/components/ui/card';
import { useFreighter } from '@/hooks/use-freighter';
import { soroswapAPI } from '@/lib/api';
import { ASSET_OPTIONS, DEFAULT_PROTOCOLS, ASSET_CONFIGS, DEFAULT_ASSET_CONFIG } from '@/lib/constants';


export default function PriceBasedAutoTrader() {
  const {
    currentPrice,
    isTracking,
    lastUpdate,
    error,
    startTracking,
    stopTracking
  } = usePriceTracker();

  // Telegram bot
  const [telegramBot, setTelegramBot] = useState<any>(null);
  const [telegramChatId, setTelegramChatId] = useState('');

  // Freighter wallet
  const freighter = useFreighter();
  const { isAvailable, isConnected, publicKey, connect, signTransaction, error: freighterError } = freighter;

  // ğŸ¯ Pre-Authorization States (GeliÅŸmiÅŸ Transfer Sistemi)
  const [preAuthBuyOrder, setPreAuthBuyOrder] = useState<{
    targetPrice: string;
    amount: string;
    requiredXLM?: number;
    estimatedOutput?: number;
    transferHash?: string;
    expiry: Date;
    status: string;
    isBot?: boolean;
  } | null>(null);
  
  const [preAuthSellOrder, setPreAuthSellOrder] = useState<{
    targetPrice: string;
    amount: string;
    expiry: Date;
    status: string;
    isBot?: boolean;
  } | null>(null);

  // ğŸ¤– Grid Trading Bot - Otomatik AlÄ±m + SatÄ±m Sistemi
  const [gridTradingBot, setGridTradingBot] = useState<{
    buyPrice: string;
    sellPrice: string;
    amount: string;
    isActive: boolean;
    currentStep: 'waiting_buy' | 'waiting_sell' | 'completed';
    purchasedAmount?: string;
    buyHash?: string;
    sellHash?: string;
    expiry: Date;
    status: string;
    isBot?: boolean;
  } | null>(null);

  // ğŸ¤– Bot Wallet Sistemi
  const [botWallet, setBotWallet] = useState<{
    publicKey: string;
    secretKey: string;
  } | null>(null);
  const [botMode, setBotMode] = useState<'manual' | 'auto'>('manual');
  const [botBalance, setBotBalance] = useState<number>(0);
  const [customWalletAddress, setCustomWalletAddress] = useState('GALA3KXZFMIQISYVBONAJH3A64CJMPYIMRC4ZTLAQ54AYE6XLYC2HE3M');

  // ğŸ¯ Fiyat BazlÄ± Otomatik Ä°ÅŸlem - Ana Odak
  const [autoTradeAssetIn, setAutoTradeAssetIn] = useState(ASSET_OPTIONS[0].value); // XLM
  const [autoTradeAssetOut, setAutoTradeAssetOut] = useState(ASSET_OPTIONS[2].value); // USDC
  const [buyTargetPrice, setBuyTargetPrice] = useState('');
  const [sellTargetPrice, setSellTargetPrice] = useState('');
  const [autoBuyAmount, setAutoBuyAmount] = useState('');
  const [autoSellAmount, setAutoSellAmount] = useState('');
  const [isAutoTradingEnabled, setIsAutoTradingEnabled] = useState(false);
  const [autoTradeStatus, setAutoTradeStatus] = useState<string | null>(null);
  const [isTrading, setIsTrading] = useState(false);
  const [hasAutoTradeError, setHasAutoTradeError] = useState(false);
  const lastAutoTradeCheck = useRef<Date | null>(null);

  // ğŸ¤– Grid Trading Bot Input States
  const [gridBuyPrice, setGridBuyPrice] = useState('');
  const [gridSellPrice, setGridSellPrice] = useState('');
  const [gridAmount, setGridAmount] = useState('');

  // ğŸ“Š Manuel Fiyat KontrolÃ¼
  const [manualPriceMode, setManualPriceMode] = useState(false);
  const [manualPrice, setManualPrice] = useState('');

  // Fiyat belirleme mantÄ±ÄŸÄ± - currentPrice'Ä± override etmek iÃ§in
  const displayPrice = manualPriceMode && manualPrice ? parseFloat(manualPrice) : currentPrice;

  // Ana sayfa ile aynÄ± dynamic trade functions
  const getAssetSymbol = useCallback((assetAddress: string): string => {
    const asset = ASSET_OPTIONS.find(a => a.value === assetAddress);
    return asset?.symbol || 'Unknown';
  }, []);

  // Asset'lere gÃ¶re dinamik maxHops ve slippage hesaplama (Ana sayfa ile aynÄ±)
  const getDynamicTradeParams = useCallback((assetInAddress: string, assetOutAddress: string) => {
    const assetInSymbol = getAssetSymbol(assetInAddress);
    const assetOutSymbol = getAssetSymbol(assetOutAddress);
    
    // Her iki asset iÃ§in konfigÃ¼rasyonlarÄ± al (type-safe)
    const assetInConfig = (ASSET_CONFIGS as any)[assetInSymbol] || DEFAULT_ASSET_CONFIG;
    const assetOutConfig = (ASSET_CONFIGS as any)[assetOutSymbol] || DEFAULT_ASSET_CONFIG;
    
    // En yÃ¼ksek maxHops ve slippage deÄŸerlerini kullan (daha gÃ¼venli)
    const maxHops = Math.max(assetInConfig.maxHops, assetOutConfig.maxHops);
    const slippageBps = Math.max(assetInConfig.slippageBps, assetOutConfig.slippageBps);
    
    console.log(`ğŸ”§ Dynamic Trade Params:
    - ${assetInSymbol}: maxHops=${assetInConfig.maxHops}, slippage=${assetInConfig.slippageBps}
    - ${assetOutSymbol}: maxHops=${assetOutConfig.maxHops}, slippage=${assetOutConfig.slippageBps}
    - Final: maxHops=${maxHops}, slippage=${slippageBps}`);
    
    return { maxHops, slippageBps };
  }, [getAssetSymbol]);

  // KullanÄ±cÄ± dostu miktarÄ± stroop'a Ã§evir (7 decimal) - Ana sayfa ile aynÄ±
  const toStroop = (val: string): string => {
    return (parseFloat(val) * 1e7).toFixed(0);
  };

  // Telegram bot yÃ¼kle
  useEffect(() => {
    const loadTelegramBot = async () => {
      if (typeof window !== 'undefined') {
        try {
          const { telegramBot: bot } = await import('@/lib/telegram');
          setTelegramBot(bot);
          const storedChatId = localStorage.getItem('telegram_chat_id');
          if (storedChatId) setTelegramChatId(storedChatId);
        } catch (error) {
          console.error('Telegram bot yÃ¼kleme hatasÄ±:', error);
        }
      }
    };
    loadTelegramBot();
  }, []);

  // ğŸ”— Freighter BaÄŸlantÄ± Fonksiyonu (Ana sayfa ile aynÄ±)
  const connectWallet = async (): Promise<void> => {
    try {
      await connect();
    } catch (error) {
      const errorMessage = (error as Error).message;
      console.error('Connect error:', errorMessage);
      
      // Freighter yÃ¼klÃ¼ deÄŸilse kullanÄ±cÄ±yÄ± yÃ¶nlendir
      if (errorMessage.includes('Freighter eklentisi yÃ¼klÃ¼ deÄŸil')) {
        alert(`âŒ Freighter Eklentisi Gerekli\n\n1. Chrome/Edge iÃ§in: https://chrome.google.com/webstore/detail/freighter/bcacfldlkkdogcmkkibnjlakofdplcbk\n2. Firefox iÃ§in: https://addons.mozilla.org/en-US/firefox/addon/freighter/\n\nEklentiyi yÃ¼kledikten sonra sayfayÄ± yenileyin.`);
        // KullanÄ±cÄ±yÄ± Freighter yÃ¼kleme sayfasÄ±na yÃ¶nlendir
        window.open('https://freighter.app/', '_blank');
      } else {
        alert('Freighter baÄŸlantÄ±sÄ± baÅŸarÄ±sÄ±z: ' + errorMessage);
      }
    }
  };

  // Bot Balance KontrolÃ¼
  const checkBotBalance = useCallback(async (botPublicKey: string) => {
    try {
      // Stellar balance API call
      const response = await fetch(`https://horizon-testnet.stellar.org/accounts/${botPublicKey}`);
      if (response.ok) {
        const account = await response.json();
        const xlmBalance = account.balances.find((b: any) => b.asset_type === 'native');
        setBotBalance(parseFloat(xlmBalance?.balance || '0'));
      }
    } catch (error) {
      console.error('Bot balance kontrol hatasÄ±:', error);
    }
  }, []);

  // ğŸ¤– Bot Wallet OluÅŸturma/YÃ¼kleme
  useEffect(() => {
    const loadBotWallet = () => {
      try {
        const storedWallet = localStorage.getItem('bot_wallet');
        if (storedWallet && publicKey) {
          const wallet = JSON.parse(storedWallet);
          setBotWallet(wallet);
          // Bot balance kontrol et
          checkBotBalance(wallet.publicKey);
        }
        
        // Custom wallet adresini yÃ¼kle
        const storedCustomAddress = localStorage.getItem('custom_wallet_address');
        if (storedCustomAddress) {
          setCustomWalletAddress(storedCustomAddress);
        }
      } catch (error) {
        console.error('Bot wallet yÃ¼kleme hatasÄ±:', error);
      }
    };
    
    if (publicKey) {
      loadBotWallet();
    }
  }, [publicKey, checkBotBalance]);

  // ğŸ¤– Yeni Bot Wallet OluÅŸturma
  const createBotWallet = useCallback(async () => {
    try {
      if (!publicKey) {
        throw new Error('Ana cÃ¼zdan baÄŸlÄ± deÄŸil');
      }

      // Stellar SDK ile yeni keypair oluÅŸtur
      const StellarSdk = await import('@stellar/stellar-sdk');
      const keypair = StellarSdk.Keypair.random();
      
      const newBotWallet = {
        publicKey: keypair.publicKey(),
        secretKey: keypair.secret()
      };

      setBotWallet(newBotWallet);
      localStorage.setItem('bot_wallet', JSON.stringify(newBotWallet));
      
      setAutoTradeStatus(`ğŸ¤– Bot cÃ¼zdanÄ± oluÅŸturuldu!
ğŸ“ Bot Address: ${newBotWallet.publicKey}
ğŸ’° Bu adrese XLM transfer edin (iÅŸlem baÅŸÄ±na ~0.5-2 XLM yeterli)
ğŸ”‘ Secret key gÃ¼venli ÅŸekilde saklandÄ±
âš ï¸ XLM transfer sonrasÄ± bot aktif olacak
ğŸ¯ Bot kendi cÃ¼zdanÄ±ndan iÅŸlem yapacak`);

      // Balance kontrol et
      setTimeout(() => checkBotBalance(newBotWallet.publicKey), 2000);

    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : 'Bilinmeyen hata';
      alert(`âŒ Bot wallet oluÅŸturma hatasÄ±: ${errorMessage}`);
    }
  }, [publicKey, checkBotBalance]);



  // ğŸ“¦ LocalStorage'dan pre-auth orders yÃ¼kle
  useEffect(() => {
    if (publicKey) {
      try {
        const buyOrder = localStorage.getItem(`preauth_buy_${publicKey}`);
        const sellOrder = localStorage.getItem(`preauth_sell_${publicKey}`);
        const gridBot = localStorage.getItem(`grid_bot_${publicKey}`);
        
        if (buyOrder) {
          const parsed = JSON.parse(buyOrder);
          // GeÃ§erlilik kontrolÃ¼
          if (new Date(parsed.expiry) > new Date()) {
            setPreAuthBuyOrder({
              ...parsed,
              expiry: new Date(parsed.expiry)
            });
          } else {
            localStorage.removeItem(`preauth_buy_${publicKey}`);
          }
        }
        
        if (sellOrder) {
          const parsed = JSON.parse(sellOrder);
          // GeÃ§erlilik kontrolÃ¼
          if (new Date(parsed.expiry) > new Date()) {
            setPreAuthSellOrder({
              ...parsed,
              expiry: new Date(parsed.expiry)
            });
          } else {
            localStorage.removeItem(`preauth_sell_${publicKey}`);
          }
        }

        if (gridBot) {
          const parsed = JSON.parse(gridBot);
          // GeÃ§erlilik kontrolÃ¼
          if (new Date(parsed.expiry) > new Date()) {
            setGridTradingBot({
              ...parsed,
              expiry: new Date(parsed.expiry)
            });
          } else {
            localStorage.removeItem(`grid_bot_${publicKey}`);
          }
        }


      } catch (error) {
        console.error('âŒ LocalStorage order loading error:', error);
      }
    }
  }, [publicKey]);

  // ğŸ’¸ Freighter ile bot'a XLM transfer etme fonksiyonu
  const transferXLMToBot = useCallback(async (requiredXLM: number) => {
    try {
      if (!publicKey || !botWallet || !signTransaction) {
        throw new Error('Wallet bilgileri eksik.');
      }

      // Freighter baÄŸlantÄ±sÄ±nÄ± kontrol et
      if (!isConnected) {
        setAutoTradeStatus('ğŸ”— Freighter baÄŸlantÄ±sÄ± gerekli. Yeniden baÄŸlanÄ±yor...');
        try {
          await connect();
          // BaÄŸlantÄ± iÃ§in kÄ±sa bekle
          await new Promise(resolve => setTimeout(resolve, 2000));
          
          if (!isConnected) {
            throw new Error('Freighter baÄŸlantÄ±sÄ± kurulamadÄ±. LÃ¼tfen tarayÄ±cÄ±da Freighter extension\'Ä±nÄ± kontrol edin ve manuel olarak baÄŸlanÄ±n.');
          }
        } catch (connectError) {
          throw new Error(`Freighter baÄŸlantÄ± hatasÄ±: ${connectError}. LÃ¼tfen sayfayÄ± yenileyin ve manuel olarak baÄŸlanÄ±n.`);
        }
      }

      setAutoTradeStatus(`ğŸ’° Freighter ile ${requiredXLM.toFixed(2)} XLM transfer ediliyor...`);

      // Stellar SDK ile payment transaction oluÅŸtur
      const StellarSdk = await import('@stellar/stellar-sdk');
      const server = new StellarSdk.Horizon.Server('https://horizon-testnet.stellar.org');
      
      // Ana cÃ¼zdan account bilgilerini al
      const sourceAccount = await server.loadAccount(publicKey);
      
      // Payment transaction oluÅŸtur
      const transaction = new StellarSdk.TransactionBuilder(sourceAccount, {
        fee: StellarSdk.BASE_FEE,
        networkPassphrase: StellarSdk.Networks.TESTNET,
      })
      .addOperation(StellarSdk.Operation.payment({
        destination: botWallet.publicKey,
        asset: StellarSdk.Asset.native(),
        amount: requiredXLM.toFixed(7),
      }))
      .setTimeout(180)
      .build();

      // Transaction XDR'Ä±nÄ± al
      const xdr = transaction.toEnvelope().toXDR('base64');
      
      setAutoTradeStatus(`ğŸ” Freighter imzasÄ± bekleniyor...`);
      
      // Freighter ile imzala
      const signedXDR = await signTransaction(xdr);
      
      setAutoTradeStatus(`ï¿½ Transfer gÃ¶nderiliyor...`);
      
      // Ä°mzalÄ± transaction'Ä± gÃ¶nder
      const signedTransaction = new StellarSdk.Transaction(signedXDR, StellarSdk.Networks.TESTNET);
      const result = await server.submitTransaction(signedTransaction);
      
      setAutoTradeStatus(`âœ… Transfer baÅŸarÄ±lÄ±! Hash: ${result.hash}`);
      
      // Bot balance'Ä±nÄ± gÃ¼ncelle
      setTimeout(() => checkBotBalance(botWallet.publicKey), 3000);
      
      return { success: true, hash: result.hash };
      
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : 'Transfer hatasÄ±';
      setAutoTradeStatus(`âŒ Transfer hatasÄ±: ${errorMessage}`);
      return { success: false, error: errorMessage };
    }
  }, [publicKey, botWallet, signTransaction, checkBotBalance, connect, isConnected]);

  // ğŸ’¸ Bot'dan kullanÄ±cÄ±ya XLM iade etme fonksiyonu
  const refundXLMFromBot = useCallback(async (amount: number) => {
    try {
      if (!publicKey || !botWallet) {
        throw new Error('Wallet bilgileri eksik.');
      }

      setAutoTradeStatus(`ğŸ’¸ ${amount.toFixed(2)} XLM iade ediliyor...`);

      const StellarSdk = await import('@stellar/stellar-sdk');
      const server = new StellarSdk.Horizon.Server('https://horizon-testnet.stellar.org');
      
      // Bot account bilgilerini al
      const botAccount = await server.loadAccount(botWallet.publicKey);
      const botKeypair = StellarSdk.Keypair.fromSecret(botWallet.secretKey);
      
      // Ä°ade transaction oluÅŸtur
      const transaction = new StellarSdk.TransactionBuilder(botAccount, {
        fee: StellarSdk.BASE_FEE,
        networkPassphrase: StellarSdk.Networks.TESTNET,
      })
      .addOperation(StellarSdk.Operation.payment({
        destination: publicKey,
        asset: StellarSdk.Asset.native(),
        amount: amount.toFixed(7),
      }))
      .setTimeout(180)
      .build();

      // Bot imza at
      transaction.sign(botKeypair);
      
      // GÃ¶nder
      const result = await server.submitTransaction(transaction);
      
      setAutoTradeStatus(`âœ… Ä°ade tamamlandÄ±! Hash: ${result.hash}`);
      
      // Bot balance'Ä±nÄ± gÃ¼ncelle
      setTimeout(() => checkBotBalance(botWallet.publicKey), 3000);
      
      return { success: true, hash: result.hash };
      
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : 'Ä°ade hatasÄ±';
      setAutoTradeStatus(`âŒ Ä°ade hatasÄ±: ${errorMessage}`);
      return { success: false, error: errorMessage };
    }
  }, [publicKey, botWallet, checkBotBalance]);

  // ğŸ¯ Pre-Authorization Functions (Manuel ve Bot ModlarÄ±)
  const createPreAuthBuyOrder = useCallback(async (useBot = false) => {
    try {
      if (!buyTargetPrice || !autoBuyAmount) {
        throw new Error('Hedef fiyat ve miktar giriniz.');
      }

      if (!publicKey || !isConnected) {
        throw new Error('CÃ¼zdan baÄŸlÄ± deÄŸil.');
      }

      const numAmount = parseFloat(autoBuyAmount);
      const assetInSymbol = ASSET_OPTIONS.find(a => a.value === autoTradeAssetIn)?.symbol;
      const assetOutSymbol = ASSET_OPTIONS.find(a => a.value === autoTradeAssetOut)?.symbol;

      if (!useBot || botMode === 'manual') {
        // ğŸ‘¤ Manuel Mod - Basit onay sistemi
        const confirmed = window.confirm(
          `ğŸ‘¤ MANUEL ALIM EMRÄ° ONAY\n\n` +
          `ğŸ’° HarcayacaÄŸÄ±nÄ±z: ${autoBuyAmount} ${assetInSymbol}\n` +
          `ğŸ“Š Hedef Fiyat: $${buyTargetPrice}\n` +
          `ğŸ’µ GÃ¼ncel Fiyat: $${displayPrice.toFixed(4)}\n\n` +
          `ğŸ‘¤ Manuel modda her iÅŸlemde Freighter ile imza atacaksÄ±nÄ±z\n` +
          `ğŸ’° Para ana cÃ¼zdanÄ±nÄ±zdan Ã§Ä±kacak\n\n` +
          `Bu alÄ±m emrini onaylÄ±yor musunuz?`
        );

        if (!confirmed) {
          setAutoTradeStatus('âŒ Manuel alÄ±m emri iptal edildi.');
          return;
        }

        // Manuel pre-auth order oluÅŸtur
        const order = {
          targetPrice: buyTargetPrice,
          amount: autoBuyAmount,
          expiry: new Date(Date.now() + 2 * 60 * 60 * 1000), // 2 saat geÃ§erli
          status: `âœ… MANUEL ALIM EMRÄ° AKTÄ°F!
ğŸ’° Harcayacak: ${autoBuyAmount} ${assetInSymbol}
ğŸ¯ Hedef Fiyat: $${buyTargetPrice}
ğŸ‘¤ Manuel Mod: Her iÅŸlemde imza gerekir
â° GeÃ§erlilik: 2 saat
ğŸ“Š Fiyat takibi aktif...`
        };

        setPreAuthBuyOrder(order);
        localStorage.setItem(`preauth_buy_${publicKey}`, JSON.stringify(order));
        setAutoTradeStatus('âœ… Manuel alÄ±m emri aktif! Hedef fiyat bekliyor...');

      } else if (useBot && botMode === 'auto' && botWallet) {
        // Bot Mod - AlÄ±m iÃ§in gerekli XLM miktarÄ±nÄ± hesapla
        setAutoTradeStatus('ğŸ’° Bot alÄ±m iÃ§in gerekli XLM hesaplanÄ±yor...');
        
        // GerÃ§ek iÅŸlem maliyeti: satÄ±n alÄ±nacak XLM + iÅŸlem Ã¼cretleri
        const baseAmount = numAmount; // SatÄ±n almak istenen XLM miktarÄ±
        const transactionFees = 0.5; // Stellar network fees (100,000 stroops = 0.01 XLM) + buffer
        const slippageBuffer = baseAmount * 0.02; // %2 slippage buffer
        const requiredXLM = baseAmount + transactionFees + slippageBuffer;

        // Quote al tahmini Ã§Ä±ktÄ± iÃ§in (Ana sayfa ile aynÄ± parametreler)
        try {
          const { maxHops, slippageBps } = getDynamicTradeParams(autoTradeAssetIn, autoTradeAssetOut);
          
          const quoteResponse = await soroswapAPI.getQuote({
            assetIn: autoTradeAssetIn,
            assetOut: autoTradeAssetOut,
            amount: toStroop(autoBuyAmount),
            tradeType: 'EXACT_IN' as const,
            protocols: DEFAULT_PROTOCOLS,
            slippageBps: slippageBps, // Dinamik slippage
            feeBps: 50,
            parts: 1,
            maxHops: maxHops // Dinamik maxHops
          });

          const estimatedOutput = parseFloat(quoteResponse.amountOut || '0') / 10000000;

          // Bot onayÄ± al
          const confirmed = window.confirm(
            `ğŸ¤– BOT ALIM EMRÄ° ONAY\n\n` +
            `ğŸ’° HarcayacaÄŸÄ±nÄ±z: ${autoBuyAmount} ${assetInSymbol}\n` +
            `ğŸ¯ AlacaÄŸÄ±nÄ±z (tahmini): ${estimatedOutput.toFixed(4)} ${assetOutSymbol}\n` +
            `ğŸ“Š Hedef Fiyat: $${buyTargetPrice}\n` +
            `ğŸ’µ GÃ¼ncel Fiyat: $${currentPrice.toFixed(4)}\n\n` +
            `ğŸ”— Freighter ile ${requiredXLM.toFixed(2)} XLM bot'a transfer edilecek\n` +
            `ğŸ¤– Bot PC'niz kapalÄ±yken otomatik trade yapacak\n` +
            `ğŸ’¸ Ä°ÅŸlem sonrasÄ± ${assetOutSymbol} cÃ¼zdanÄ±nÄ±za gelecek\n` +
            `âŒ Ä°ptal ederseniz XLM iade edilecek\n\n` +
            `Bu bot alÄ±m emrini onaylÄ±yor musunuz?`
          );

          if (!confirmed) {
            setAutoTradeStatus('âŒ Bot alÄ±m emri iptal edildi.');
            return;
          }

          // Freighter baÄŸlantÄ±sÄ±nÄ± kontrol et ve gerekirse yeniden baÄŸlan
          setAutoTradeStatus('ğŸ”— Freighter baÄŸlantÄ±sÄ± kontrol ediliyor...');
          
          try {
            // Freighter'a yeniden baÄŸlanmayÄ± dene
            if (!isConnected) {
              setAutoTradeStatus('ğŸ”— Freighter\'a baÄŸlanÄ±yor...');
              await connect();
              
              // BaÄŸlantÄ± kontrolÃ¼ iÃ§in kÄ±sa bekle
              await new Promise(resolve => setTimeout(resolve, 1000));
              
              if (!isConnected) {
                throw new Error('Freighter baÄŸlantÄ±sÄ± kurulamadÄ±. LÃ¼tfen manuel olarak baÄŸlanÄ±n.');
              }
            }
            
            setAutoTradeStatus(`ğŸ’¸ ${requiredXLM.toFixed(2)} XLM bot wallet'a transfer ediliyor...`);
            
            // Freighter ile bot'a XLM transfer et
            const transferResult = await transferXLMToBot(requiredXLM);
            
            if (!transferResult.success) {
              throw new Error(transferResult.error || 'XLM transfer baÅŸarÄ±sÄ±z');
            }
            
            setAutoTradeStatus('âœ… XLM transfer baÅŸarÄ±lÄ±! Bot alÄ±m emri oluÅŸturuluyor...');

            // Bot pre-auth order oluÅŸtur
            const order = {
              targetPrice: buyTargetPrice,
              amount: autoBuyAmount,
              requiredXLM: requiredXLM,
              estimatedOutput: estimatedOutput,
              transferHash: transferResult.hash,
              expiry: new Date(Date.now() + 2 * 60 * 60 * 1000), // 2 saat geÃ§erli
              isBot: true,
              status: `âœ… BOT ALIM EMRÄ° AKTÄ°F!
ğŸ’° Harcayacak: ${autoBuyAmount} ${assetInSymbol}
ğŸ¯ Hedef Fiyat: $${buyTargetPrice}
ğŸ’¸ Alacak Token: ~${estimatedOutput.toFixed(4)} ${assetOutSymbol}
ğŸ¤– Bot HazÄ±r: ${requiredXLM.toFixed(2)} XLM transfer edildi
ğŸ’³ Transfer Hash: ${transferResult.hash}
â° GeÃ§erlilik: 2 saat
ğŸ“Š PC kapalÄ± olabilir - Bot otomatik takip!`
            };

            setPreAuthBuyOrder(order);
            localStorage.setItem(`preauth_buy_${publicKey}`, JSON.stringify(order));
            setAutoTradeStatus('âœ… Bot alÄ±m emri aktif! Hedef fiyat bekliyor...');

          } catch (transferError) {
            setAutoTradeStatus(`âŒ Transfer hatasÄ±: ${transferError}`);
            return;
          }

        } catch (quoteError) {
          // Quote alamazsak basit onay
          console.error('Quote hatasÄ±:', quoteError);
          setAutoTradeStatus('âš ï¸ Quote alÄ±namadÄ±, basit bot alÄ±m emri oluÅŸturuluyor...');
          
          const confirmed = window.confirm(
            `ğŸ¤– BOT ALIM EMRÄ° ONAY (Basit)\n\n` +
            `ğŸ’° HarcayacaÄŸÄ±nÄ±z: ${autoBuyAmount} ${assetInSymbol}\n` +
            `ğŸ¯ Hedef Fiyat: $${buyTargetPrice}\n` +
            `ğŸ’µ GÃ¼ncel Fiyat: $${currentPrice.toFixed(4)}\n\n` +
            `Bu bot alÄ±m emrini onaylÄ±yor musunuz?`
          );

          if (!confirmed) {
            setAutoTradeStatus('âŒ Bot alÄ±m emri iptal edildi.');
            return;
          }

          try {
            const transferResult = await transferXLMToBot(requiredXLM);
            
            if (!transferResult.success) {
              setAutoTradeStatus('âŒ XLM transfer baÅŸarÄ±sÄ±z.');
              return;
            }

            const order = {
              targetPrice: buyTargetPrice,
              amount: autoBuyAmount,
              requiredXLM: requiredXLM,
              transferHash: transferResult.hash,
              expiry: new Date(Date.now() + 2 * 60 * 60 * 1000),
              isBot: true,
              status: `âœ… BOT ALIM EMRÄ° AKTÄ°F!
ğŸ’° Harcayacak: ${autoBuyAmount} ${assetInSymbol}
ğŸ¯ Hedef: $${buyTargetPrice}
ğŸ¤– Bot HazÄ±r: ${requiredXLM.toFixed(2)} XLM yatÄ±rÄ±ldÄ±
ğŸ’³ Transfer Hash: ${transferResult.hash}
â° GeÃ§erlilik: 2 saat`
            };

            setPreAuthBuyOrder(order);
            localStorage.setItem(`preauth_buy_${publicKey}`, JSON.stringify(order));
            setAutoTradeStatus('âœ… Bot alÄ±m emri aktif! Hedef fiyat bekliyor...');
            
          } catch (transferError) {
            setAutoTradeStatus(`âŒ Transfer hatasÄ±: ${transferError}`);
            return;
          }
        }
      } else {
        throw new Error('Bot modu seÃ§ildi ama bot wallet oluÅŸturulmamÄ±ÅŸ. Ã–nce bot wallet oluÅŸturun.');
      }

    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : 'Bilinmeyen hata';
      setAutoTradeStatus(`âŒ AlÄ±m onayÄ± hatasÄ±: ${errorMessage}`);
    }
  }, [buyTargetPrice, autoBuyAmount, publicKey, isConnected, currentPrice, displayPrice, autoTradeAssetIn, autoTradeAssetOut, botMode, botWallet, transferXLMToBot, connect, getDynamicTradeParams]);

  const createPreAuthSellOrder = useCallback(async (useBot = false) => {
    try {
      if (!sellTargetPrice || !autoSellAmount) {
        throw new Error('Hedef fiyat ve miktar giriniz.');
      }

      if (!publicKey || !isConnected) {
        throw new Error('CÃ¼zdan baÄŸlÄ± deÄŸil.');
      }

      const numAmount = parseFloat(autoSellAmount);
      const assetInSymbol = ASSET_OPTIONS.find(a => a.value === autoTradeAssetIn)?.symbol;
      const assetOutSymbol = ASSET_OPTIONS.find(a => a.value === autoTradeAssetOut)?.symbol;

      if (!useBot || botMode === 'manual') {
        // ğŸ‘¤ Manuel Mod - Basit onay sistemi
        const confirmed = window.confirm(
          `ğŸ‘¤ MANUEL SATIM EMRÄ° ONAY\n\n` +
          `ğŸ’¸ SatacaÄŸÄ±nÄ±z: ${autoSellAmount} ${assetInSymbol}\n` +
          `ğŸ“Š Hedef Fiyat: $${sellTargetPrice}\n` +
          `ğŸ’µ GÃ¼ncel Fiyat: $${currentPrice.toFixed(4)}\n\n` +
          `ğŸ‘¤ Manuel modda her iÅŸlemde Freighter ile imza atacaksÄ±nÄ±z\n` +
          `ğŸ’° Token ana cÃ¼zdanÄ±nÄ±zdan Ã§Ä±kacak\n\n` +
          `Bu satÄ±m emrini onaylÄ±yor musunuz?`
        );

        if (!confirmed) {
          setAutoTradeStatus('âŒ Manuel satÄ±m emri iptal edildi.');
          return;
        }

        // Manuel pre-auth order oluÅŸtur
        const order = {
          targetPrice: sellTargetPrice,
          amount: autoSellAmount,
          expiry: new Date(Date.now() + 2 * 60 * 60 * 1000), // 2 saat geÃ§erli
          status: `âœ… MANUEL SATIM EMRÄ° AKTÄ°F!
ğŸ’¸ Satacak: ${autoSellAmount} ${assetInSymbol}
ğŸ¯ Hedef Fiyat: $${sellTargetPrice}
ğŸ‘¤ Manuel Mod: Her iÅŸlemde imza gerekir
â° GeÃ§erlilik: 2 saat
ğŸ“Š Fiyat takibi aktif...`
        };

        setPreAuthSellOrder(order);
        localStorage.setItem(`preauth_sell_${publicKey}`, JSON.stringify(order));
        setAutoTradeStatus('âœ… Manuel satÄ±m emri aktif! Hedef fiyat bekliyor...');

      } else if (useBot && botMode === 'auto' && botWallet) {
        // ğŸ¤– Bot Mod - SatÄ±m iÃ§in gereken asset'i bot'a transfer et
        setAutoTradeStatus('ğŸ’° Bot satÄ±m iÃ§in gerekli token miktarÄ± hesaplanÄ±yor...');
        
        // SatÄ±m iÃ§in gereken token miktarÄ± = satÄ±lacak miktar + iÅŸlem Ã¼creti
        const requiredTokenAmount = numAmount; // Ana token miktarÄ±
        const requiredXLMForFees = 2; // Stellar transaction fees iÃ§in

        // Quote al tahmini Ã§Ä±ktÄ± iÃ§in (Ana sayfa ile aynÄ± parametreler)
        try {
          const { maxHops, slippageBps } = getDynamicTradeParams(autoTradeAssetIn, autoTradeAssetOut);
          
          const quoteResponse = await soroswapAPI.getQuote({
            assetIn: autoTradeAssetIn,
            assetOut: autoTradeAssetOut,
            amount: toStroop(autoSellAmount),
            tradeType: 'EXACT_IN' as const,
            protocols: DEFAULT_PROTOCOLS,
            slippageBps: slippageBps, // Dinamik slippage
            feeBps: 50,
            parts: 1,
            maxHops: maxHops // Dinamik maxHops
          });

          const estimatedOutput = parseFloat(quoteResponse.amountOut || '0') / 10000000;

          // Bot onayÄ± al
          const confirmed = window.confirm(
            `ğŸ¤– BOT SATIM EMRÄ° ONAY\n\n` +
            `ğŸ’¸ SatacaÄŸÄ±nÄ±z: ${autoSellAmount} ${assetInSymbol}\n` +
            `ğŸ¯ AlacaÄŸÄ±nÄ±z (tahmini): ${estimatedOutput.toFixed(4)} ${assetOutSymbol}\n` +
            `ğŸ“Š Hedef Fiyat: $${sellTargetPrice}\n` +
            `ğŸ’µ GÃ¼ncel Fiyat: $${currentPrice.toFixed(4)}\n\n` +
            `ğŸ”— Freighter ile ${requiredXLMForFees.toFixed(2)} XLM iÅŸlem Ã¼creti bot'a gÃ¶nderilecek\n` +
            `ğŸ“¤ SatÄ±lacak ${assetInSymbol} tokenlar manuel olarak bot'a transfer edilmeli\n` +
            `ğŸ¤– Bot PC'niz kapalÄ±yken otomatik trade yapacak\n` +
            `ğŸ’¸ Ä°ÅŸlem sonrasÄ± ${assetOutSymbol} cÃ¼zdanÄ±nÄ±za gelecek\n` +
            `âŒ Ä°ptal ederseniz transfer edilen Ã¼cret iade edilecek\n\n` +
            `Bu bot satÄ±m emrini onaylÄ±yor musunuz?`
          );

          if (!confirmed) {
            setAutoTradeStatus('âŒ Bot satÄ±m emri iptal edildi.');
            return;
          }

          // Freighter baÄŸlantÄ±sÄ±nÄ± kontrol et ve gerekirse yeniden baÄŸlan
          setAutoTradeStatus('ğŸ”— Freighter baÄŸlantÄ±sÄ± kontrol ediliyor...');
          
          try {
            // Freighter'a yeniden baÄŸlanmayÄ± dene
            if (!isConnected) {
              setAutoTradeStatus('ğŸ”— Freighter\'a baÄŸlanÄ±yor...');
              await connect();
              
              // BaÄŸlantÄ± kontrolÃ¼ iÃ§in kÄ±sa bekle
              await new Promise(resolve => setTimeout(resolve, 1000));
              
              if (!isConnected) {
                throw new Error('Freighter baÄŸlantÄ±sÄ± kurulamadÄ±. LÃ¼tfen manuel olarak baÄŸlanÄ±n.');
              }
            }
            
            setAutoTradeStatus(`ğŸ’¸ ${requiredXLMForFees.toFixed(2)} XLM iÅŸlem Ã¼creti bot wallet'a transfer ediliyor...`);
            
            // Freighter ile bot'a sadece iÅŸlem Ã¼creti (XLM) transfer et
            const transferResult = await transferXLMToBot(requiredXLMForFees);
            
            if (!transferResult.success) {
              throw new Error(transferResult.error || 'XLM transfer baÅŸarÄ±sÄ±z');
            }
            
            setAutoTradeStatus(`âœ… XLM transfer baÅŸarÄ±lÄ±! Bot satÄ±m emri oluÅŸturuluyor...\n\nâš ï¸ Ã–NEMLÄ°: Åimdi ${requiredTokenAmount} ${assetInSymbol} tokenlarÄ±nÄ± bot adresine manuel transfer edin:\n${botWallet.publicKey}`);

            // Bot pre-auth order oluÅŸtur
            const order = {
              targetPrice: sellTargetPrice,
              amount: autoSellAmount,
              requiredXLM: requiredXLMForFees,
              requiredTokenAmount: requiredTokenAmount,
              estimatedOutput: estimatedOutput,
              transferHash: transferResult.hash,
              expiry: new Date(Date.now() + 2 * 60 * 60 * 1000), // 2 saat geÃ§erli
              isBot: true,
              status: `âœ… BOT SATIM EMRÄ° AKTÄ°F!
ğŸ’¸ Satacak: ${autoSellAmount} ${assetInSymbol}
ğŸ¯ Hedef Fiyat: $${sellTargetPrice}
ğŸ’¸ Alacak Token: ~${estimatedOutput.toFixed(4)} ${assetOutSymbol}
ğŸ¤– Bot HazÄ±r: ${requiredXLMForFees.toFixed(2)} XLM iÅŸlem Ã¼creti yatÄ±rÄ±ldÄ±
ï¿½ Transfer Hash: ${transferResult.hash}
âš ï¸ MANUEL: ${requiredTokenAmount} ${assetInSymbol} bot'a transfer edin!
ğŸ¦ Bot Adresi: ${botWallet.publicKey}
â° GeÃ§erlilik: 2 saat
ğŸ“Š PC kapalÄ± olabilir - Bot otomatik takip!`
            };

            setPreAuthSellOrder(order);
            localStorage.setItem(`preauth_sell_${publicKey}`, JSON.stringify(order));
            setAutoTradeStatus('âœ… Bot satÄ±m emri aktif! TokenlarÄ± bot adresine transfer edin ve hedef fiyat bekliyor...');

          } catch (transferError) {
            setAutoTradeStatus(`âŒ Transfer hatasÄ±: ${transferError}`);
            return;
          }

        } catch (quoteError) {
          // Quote alamazsak basit onay
          console.error('Quote hatasÄ±:', quoteError);
          setAutoTradeStatus('âš ï¸ Quote alÄ±namadÄ±, basit bot satÄ±m emri oluÅŸturuluyor...');
          
          const confirmed = window.confirm(
            `ğŸ¤– BOT SATIM EMRÄ° ONAY (Basit)\n\n` +
            `ğŸ’¸ SatacaÄŸÄ±nÄ±z: ${autoSellAmount} ${assetInSymbol}\n` +
            `ğŸ¯ Hedef Fiyat: $${sellTargetPrice}\n` +
            `ğŸ’µ GÃ¼ncel Fiyat: $${currentPrice.toFixed(4)}\n\n` +
            `Bu bot satÄ±m emrini onaylÄ±yor musunuz?`
          );

          if (!confirmed) {
            setAutoTradeStatus('âŒ Bot satÄ±m emri iptal edildi.');
            return;
          }

          try {
            const transferResult = await transferXLMToBot(requiredXLMForFees);
            
            if (!transferResult.success) {
              setAutoTradeStatus('âŒ XLM transfer baÅŸarÄ±sÄ±z.');
              return;
            }

            const order = {
              targetPrice: sellTargetPrice,
              amount: autoSellAmount,
              requiredXLM: requiredXLMForFees,
              requiredTokenAmount: requiredTokenAmount,
              transferHash: transferResult.hash,
              expiry: new Date(Date.now() + 2 * 60 * 60 * 1000),
              isBot: true,
              status: `âœ… BOT SATIM EMRÄ° AKTÄ°F!
ğŸ’¸ Satacak: ${autoSellAmount} ${assetInSymbol}
ğŸ¯ Hedef: $${sellTargetPrice}
ğŸ¤– Bot HazÄ±r: ${requiredXLMForFees.toFixed(2)} XLM iÅŸlem Ã¼creti yatÄ±rÄ±ldÄ±
ğŸ’³ Transfer Hash: ${transferResult.hash}
âš ï¸ MANUEL: ${requiredTokenAmount} ${assetInSymbol} bot'a transfer edin!
â° GeÃ§erlilik: 2 saat`
            };

            setPreAuthSellOrder(order);
            localStorage.setItem(`preauth_sell_${publicKey}`, JSON.stringify(order));
            setAutoTradeStatus('âœ… Bot satÄ±m emri aktif! TokenlarÄ± transfer edin ve hedef fiyat bekliyor...');
            
          } catch (transferError) {
            setAutoTradeStatus(`âŒ Transfer hatasÄ±: ${transferError}`);
            return;
          }
        }
      } else {
        throw new Error('Bot modu seÃ§ildi ama bot wallet oluÅŸturulmamÄ±ÅŸ. Ã–nce bot wallet oluÅŸturun.');
      }

    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : 'Bilinmeyen hata';
      setAutoTradeStatus(`âŒ SatÄ±m onayÄ± hatasÄ±: ${errorMessage}`);
    }
  }, [sellTargetPrice, autoSellAmount, publicKey, isConnected, currentPrice, autoTradeAssetIn, autoTradeAssetOut, botMode, botWallet, transferXLMToBot, connect, getDynamicTradeParams]);

  // ğŸ¤– Grid Trading Bot - Otomatik AlÄ±m + SatÄ±m Fonksiyonu
  const createGridTradingBot = useCallback(async (useBot = false) => {
    try {
      if (!gridBuyPrice || !gridSellPrice || !gridAmount) {
        throw new Error('AlÄ±m fiyatÄ±, satÄ±m fiyatÄ± ve miktar giriniz.');
      }

      if (!publicKey || !isConnected) {
        throw new Error('CÃ¼zdan baÄŸlÄ± deÄŸil.');
      }

      const buyPrice = parseFloat(gridBuyPrice);
      const sellPrice = parseFloat(gridSellPrice);
      const amount = parseFloat(gridAmount);

      if (buyPrice >= sellPrice) {
        throw new Error('AlÄ±m fiyatÄ± satÄ±m fiyatÄ±ndan dÃ¼ÅŸÃ¼k olmalÄ±dÄ±r.');
      }

      if (buyPrice <= 0 || sellPrice <= 0 || amount <= 0) {
        throw new Error('TÃ¼m deÄŸerler pozitif olmalÄ±dÄ±r.');
      }

      const assetInSymbol = ASSET_OPTIONS.find(a => a.value === autoTradeAssetIn)?.symbol;
      const assetOutSymbol = ASSET_OPTIONS.find(a => a.value === autoTradeAssetOut)?.symbol;

      if (!useBot || botMode === 'manual') {
        // ğŸ‘¤ Manuel Grid Trading Bot
        const confirmed = window.confirm(
          `ğŸ‘¤ MANUEL GRID TRADING BOT ONAY\n\n` +
          `ï¿½ Ä°ÅLEM SIRASI (Otomatik DÃ¶ngÃ¼):\n` +
          `1ï¸âƒ£ ALIM: Fiyat $${gridBuyPrice}'a dÃ¼ÅŸtÃ¼ÄŸÃ¼nde (â‰¤ eÅŸit veya altÄ±nda)\n` +
          `   â†’ ${gridAmount} ${assetInSymbol} alÄ±nacak\n` +
          `2ï¸âƒ£ SATIM: AlÄ±m sonrasÄ± fiyat $${gridSellPrice}'a Ã§Ä±ktÄ±ÄŸÄ±nda (â‰¥ eÅŸit veya Ã¼stÃ¼nde)\n` +
          `   â†’ AlÄ±nan tokenlar satÄ±lacak\n` +
          `3ï¸âƒ£ KAR: KazanÃ§ ana cÃ¼zdanÄ±nÄ±za transfer edilecek\n\n` +
          `ğŸ“Š AlÄ±m FiyatÄ±: $${gridBuyPrice}\n` +
          `ğŸ“Š SatÄ±m FiyatÄ±: $${gridSellPrice}\n` +
          `ğŸ’° Ä°ÅŸlem MiktarÄ±: ${gridAmount} ${assetInSymbol}\n` +
          `ğŸ“ˆ Kar Beklentisi: ${((sellPrice - buyPrice) / buyPrice * 100).toFixed(2)}%\n\n` +
          `ğŸ‘¤ Manuel modda her iÅŸlemde Freighter ile imza atacaksÄ±nÄ±z\n` +
          `âš ï¸ Ã–NEMLÄ°: Ä°lk Ã¶nce ALIM, sonra SATIM gerÃ§ekleÅŸir\n\n` +
          `Bu grid trading bot'unu onaylÄ±yor musunuz?`
        );

        if (!confirmed) {
          setAutoTradeStatus('âŒ Manuel grid trading bot iptal edildi.');
          return;
        }

        // Manuel grid bot oluÅŸtur
        const gridBot = {
          buyPrice: gridBuyPrice,
          sellPrice: gridSellPrice,
          amount: gridAmount,
          isActive: true,
          currentStep: 'waiting_buy' as const,
          expiry: new Date(Date.now() + 24 * 60 * 60 * 1000), // 24 saat geÃ§erli
          status: `âœ… MANUEL GRID BOT AKTÄ°F!
ğŸ”„ Ä°ÅLEM SIRASI (Otomatik DÃ¶ngÃ¼):
1ï¸âƒ£ ALIM AÅAMASI: Fiyat â‰¤ $${gridBuyPrice} (eÅŸit veya altÄ±nda) â†’ ${gridAmount} ${assetInSymbol} alÄ±m
2ï¸âƒ£ SATIM AÅAMASI: AlÄ±m sonrasÄ± fiyat â‰¥ $${gridSellPrice} (eÅŸit veya Ã¼stÃ¼nde) â†’ SatÄ±m
3ï¸âƒ£ KAR TRANSFERÄ°: KazanÃ§ cÃ¼zdanÄ±nÄ±za transfer

ğŸ’° Miktar: ${gridAmount} ${assetInSymbol}
ğŸ“ˆ Beklenen Kar: ${((sellPrice - buyPrice) / buyPrice * 100).toFixed(2)}%
ğŸ‘¤ Manuel Mod: Her iÅŸlemde imza gerekir
ğŸ“Š ÅU ANDA: 1ï¸âƒ£ AlÄ±m fiyatÄ± bekleniyor ($${gridBuyPrice} ve altÄ±)
â° GeÃ§erlilik: 24 saat`
        };

        setGridTradingBot(gridBot);
        localStorage.setItem(`grid_bot_${publicKey}`, JSON.stringify(gridBot));
        setAutoTradeStatus('âœ… Manuel grid trading bot aktif! AlÄ±m fiyatÄ± bekleniyor...');

      } else if (useBot && botMode === 'auto' && botWallet) {
        // ğŸ¤– Otomatik Grid Trading Bot
        setAutoTradeStatus('ğŸ’° Grid bot iÃ§in gerekli XLM hesaplanÄ±yor...');
        
        // Grid bot iÃ§in gerekli XLM: alÄ±m tutarÄ± + iÅŸlem Ã¼cretleri + buffer
        const baseAmount = amount; // AlÄ±nacak miktar
        const transactionFees = 1; // Ä°ki iÅŸlem iÃ§in (buy + sell)
        const slippageBuffer = baseAmount * 0.02; // %2 slippage buffer
        const requiredXLM = baseAmount + transactionFees + slippageBuffer;

        try {
          // Quote al tahmini Ã§Ä±ktÄ± iÃ§in - RETRY MEKANÄ°ZMASI
          const { maxHops, slippageBps } = getDynamicTradeParams(autoTradeAssetIn, autoTradeAssetOut);
          
          let quoteResponse: any;
          let retryCount = 0;
          const maxRetries = 3;
          
          while (retryCount < maxRetries) {
            try {
              setAutoTradeStatus(`ğŸ’° Grid bot iÃ§in quote alÄ±nÄ±yor... (Deneme ${retryCount + 1}/${maxRetries})`);
              
              quoteResponse = await Promise.race([
                soroswapAPI.getQuote({
                  assetIn: autoTradeAssetIn,
                  assetOut: autoTradeAssetOut,
                  amount: toStroop(gridAmount),
                  tradeType: 'EXACT_IN' as const,
                  protocols: DEFAULT_PROTOCOLS,
                  slippageBps: slippageBps,
                  feeBps: 50,
                  parts: 1,
                  maxHops: maxHops
                }),
                new Promise((_, reject) => 
                  setTimeout(() => reject(new Error(`Grid bot quote timeout (${20 + (retryCount * 10)} saniye)`)), 20000 + (retryCount * 10000))
                )
              ]) as any;
              
              // BaÅŸarÄ±lÄ± olursa dÃ¶ngÃ¼den Ã§Ä±k
              break;
              
            } catch (quoteError) {
              retryCount++;
              console.error(`Grid bot quote deneme ${retryCount} hatasÄ±:`, quoteError);
              
              if (retryCount >= maxRetries) {
                throw new Error(`Grid bot quote API ${maxRetries} deneme sonrasÄ± baÅŸarÄ±sÄ±z: ${quoteError instanceof Error ? quoteError.message : 'Bilinmeyen hata'}`);
              }
              
              // Bir sonraki deneme iÃ§in bekle
              setAutoTradeStatus(`â³ Quote hatasÄ±, ${2 * retryCount} saniye sonra tekrar denenecek...`);
              await new Promise(resolve => setTimeout(resolve, 2000 * retryCount));
            }
          }

          const estimatedOutput = parseFloat(quoteResponse.amountOut || '0') / 10000000;

          // Grid bot onayÄ± al
          const confirmed = window.confirm(
            `ğŸ¤– OTOMATIK GRID TRADING BOT ONAY\n\n` +
            `ï¿½ OTOMATÄ°K Ä°ÅLEM SIRASI:\n` +
            `1ï¸âƒ£ ALIM AÅAMASI: Fiyat $${gridBuyPrice}'a dÃ¼ÅŸtÃ¼ÄŸÃ¼nde (â‰¤ eÅŸit veya altÄ±nda)\n` +
            `   â†’ ${gridAmount} ${assetInSymbol} otomatik alÄ±m\n` +
            `   â†’ Tahmini: ${estimatedOutput.toFixed(4)} ${assetOutSymbol} alÄ±nacak\n` +
            `2ï¸âƒ£ SATIM AÅAMASI: AlÄ±m sonrasÄ± fiyat $${gridSellPrice}'a Ã§Ä±ktÄ±ÄŸÄ±nda (â‰¥ eÅŸit veya Ã¼stÃ¼nde)\n` +
            `   â†’ AlÄ±nan tokenlar otomatik satÄ±m\n` +
            `3ï¸âƒ£ KAR TRANSFERÄ°: KazanÃ§ otomatik olarak cÃ¼zdanÄ±nÄ±za transfer\n\n` +
            `ğŸ“Š AlÄ±m FiyatÄ±: $${gridBuyPrice}\n` +
            `ğŸ“Š SatÄ±m FiyatÄ±: $${gridSellPrice}\n` +
            `ğŸ’° Ä°ÅŸlem MiktarÄ±: ${gridAmount} ${assetInSymbol}\n` +
            `ğŸ“ˆ Kar Beklentisi: ${((sellPrice - buyPrice) / buyPrice * 100).toFixed(2)}%\n\n` +
            `ğŸ”— ${requiredXLM.toFixed(2)} XLM bot'a transfer edilecek\n` +
            `ğŸ¤– Bot PC'niz kapalÄ±yken Ã§alÄ±ÅŸacak\n` +
            `ğŸ’¸ TÃ¼m iÅŸlemler otomatik gerÃ§ekleÅŸecek\n` +
            `âš ï¸ Ã–NEMLÄ°: Ä°lk Ã¶nce ALIM, sonra SATIM gerÃ§ekleÅŸir\n\n` +
            `Bu otomatik grid trading bot'unu onaylÄ±yor musunuz?`
          );

          if (!confirmed) {
            setAutoTradeStatus('âŒ Otomatik grid trading bot iptal edildi.');
            return;
          }

          // Freighter baÄŸlantÄ±sÄ±nÄ± kontrol et
          setAutoTradeStatus('ğŸ”— Freighter baÄŸlantÄ±sÄ± kontrol ediliyor...');
          
          if (!isConnected) {
            setAutoTradeStatus('ğŸ”— Freighter\'a baÄŸlanÄ±yor...');
            await connect();
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            if (!isConnected) {
              throw new Error('Freighter baÄŸlantÄ±sÄ± kurulamadÄ±. LÃ¼tfen manuel olarak baÄŸlanÄ±n.');
            }
          }
          
          setAutoTradeStatus(`ğŸ’¸ ${requiredXLM.toFixed(2)} XLM grid bot wallet'a transfer ediliyor...`);
          
          // Freighter ile bot'a XLM transfer et
          const transferResult = await transferXLMToBot(requiredXLM);
          
          if (!transferResult.success) {
            throw new Error(transferResult.error || 'XLM transfer baÅŸarÄ±sÄ±z');
          }
          
          setAutoTradeStatus('âœ… XLM transfer baÅŸarÄ±lÄ±! Grid trading bot oluÅŸturuluyor...');

          // Otomatik grid bot oluÅŸtur
          const gridBot = {
            buyPrice: gridBuyPrice,
            sellPrice: gridSellPrice,
            amount: gridAmount,
            isActive: true,
            currentStep: 'waiting_buy' as const,
            expiry: new Date(Date.now() + 24 * 60 * 60 * 1000), // 24 saat geÃ§erli
            isBot: true,
            status: `âœ… OTOMATIK GRID BOT AKTÄ°F!
ğŸ”„ OTOMATÄ°K Ä°ÅLEM SIRASI:
1ï¸âƒ£ ALIM AÅAMASI: Fiyat â‰¤ $${gridBuyPrice} (eÅŸit veya altÄ±nda) â†’ ${gridAmount} ${assetInSymbol} otomatik alÄ±m
2ï¸âƒ£ SATIM AÅAMASI: AlÄ±m sonrasÄ± fiyat â‰¥ $${gridSellPrice} (eÅŸit veya Ã¼stÃ¼nde) â†’ Otomatik satÄ±m  
3ï¸âƒ£ KAR TRANSFERÄ°: KazanÃ§ otomatik cÃ¼zdanÄ±nÄ±za transfer

ğŸ’° Miktar: ${gridAmount} ${assetInSymbol}
ğŸ¯ Tahmini AlÄ±m: ${estimatedOutput.toFixed(4)} ${assetOutSymbol}
ğŸ“ˆ Beklenen Kar: ${((sellPrice - buyPrice) / buyPrice * 100).toFixed(2)}%
ğŸ¤– Bot HazÄ±r: ${requiredXLM.toFixed(2)} XLM transfer edildi
ğŸ’³ Transfer Hash: ${transferResult.hash}
ğŸ“Š ÅU ANDA: 1ï¸âƒ£ AlÄ±m fiyatÄ± bekleniyor ($${gridBuyPrice} ve altÄ±)
â° GeÃ§erlilik: 24 saat
ğŸ”„ PC kapalÄ± olabilir - Bot otomatik dÃ¶ngÃ¼!`
          };

          setGridTradingBot(gridBot);
          localStorage.setItem(`grid_bot_${publicKey}`, JSON.stringify(gridBot));
          setAutoTradeStatus('âœ… Otomatik grid trading bot aktif! AlÄ±m fiyatÄ± bekleniyor...');

        } catch (quoteError) {
          // Quote alamazsak basit grid bot oluÅŸtur
          console.error('Grid bot quote hatasÄ±:', quoteError);
          setAutoTradeStatus('âš ï¸ Quote alÄ±namadÄ±, basit grid bot oluÅŸturuluyor...');
          
          const confirmed = window.confirm(
            `ğŸ¤– GRID BOT ONAY (Quote AlÄ±namadÄ±)\n\n` +
            `ğŸ“Š AlÄ±m FiyatÄ±: $${gridBuyPrice}\n` +
            `ğŸ“Š SatÄ±m FiyatÄ±: $${gridSellPrice}\n` +
            `ğŸ’° Ä°ÅŸlem MiktarÄ±: ${gridAmount} ${assetInSymbol}\n` +
            `ğŸ“ˆ Kar Beklentisi: ${((sellPrice - buyPrice) / buyPrice * 100).toFixed(2)}%\n\n` +
            `âš ï¸ Soroswap API'den quote alÄ±namadÄ±, basit mod ile devam edilsin mi?\n` +
            `ğŸ”„ Grid bot Ã§alÄ±ÅŸacak ancak tahmini Ã§Ä±ktÄ± hesaplanamadÄ±\n\n` +
            `Bu grid bot'unu yine de oluÅŸturmak istiyor musunuz?`
          );

          if (!confirmed) {
            setAutoTradeStatus('âŒ Grid bot oluÅŸturma iptal edildi.');
            return;
          }

          try {
            // Freighter baÄŸlantÄ±sÄ±nÄ± kontrol et
            if (!isConnected) {
              setAutoTradeStatus('ğŸ”— Freighter\'a baÄŸlanÄ±yor...');
              await connect();
              await new Promise(resolve => setTimeout(resolve, 1000));
              
              if (!isConnected) {
                throw new Error('Freighter baÄŸlantÄ±sÄ± kurulamadÄ±. LÃ¼tfen manuel olarak baÄŸlanÄ±n.');
              }
            }
            
            setAutoTradeStatus(`ğŸ’¸ ${requiredXLM.toFixed(2)} XLM grid bot wallet'a transfer ediliyor...`);
            
            const transferResult = await transferXLMToBot(requiredXLM);
            
            if (!transferResult.success) {
              throw new Error(transferResult.error || 'XLM transfer baÅŸarÄ±sÄ±z');
            }

            // Basit grid bot oluÅŸtur (quote olmadan)
            const gridBot = {
              buyPrice: gridBuyPrice,
              sellPrice: gridSellPrice,
              amount: gridAmount,
              isActive: true,
              currentStep: 'waiting_buy' as const,
              expiry: new Date(Date.now() + 24 * 60 * 60 * 1000),
              isBot: true,
              status: `âœ… GRID BOT AKTÄ°F (Basit Mod)!
ğŸ¯ AlÄ±m Hedefi: $${gridBuyPrice} (â‰¤ eÅŸit veya altÄ±nda)
ğŸ¯ SatÄ±m Hedefi: $${gridSellPrice} (â‰¥ eÅŸit veya Ã¼stÃ¼nde)
ğŸ’° Miktar: ${gridAmount} ${assetInSymbol}
ğŸ“ˆ Beklenen Kar: ${((sellPrice - buyPrice) / buyPrice * 100).toFixed(2)}%
ğŸ¤– Bot HazÄ±r: ${requiredXLM.toFixed(2)} XLM transfer edildi
ğŸ’³ Transfer Hash: ${transferResult.hash}
âš ï¸ Quote alÄ±namadÄ± - Basit mod aktif
ğŸ“Š Durum: AlÄ±m fiyatÄ± bekleniyor ($${gridBuyPrice} ve altÄ±)
â° GeÃ§erlilik: 24 saat
ğŸ”„ PC kapalÄ± olabilir - Bot otomatik dÃ¶ngÃ¼!`
            };

            setGridTradingBot(gridBot);
            localStorage.setItem(`grid_bot_${publicKey}`, JSON.stringify(gridBot));
            setAutoTradeStatus('âœ… Grid bot aktif! (Basit mod) AlÄ±m fiyatÄ± bekleniyor...');
            
          } catch (transferError) {
            setAutoTradeStatus(`âŒ Transfer hatasÄ±: ${transferError}`);
            return;
          }
        }
      } else {
        throw new Error('Bot modu seÃ§ildi ama bot wallet oluÅŸturulmamÄ±ÅŸ. Ã–nce bot wallet oluÅŸturun.');
      }

      // Input alanlarÄ±nÄ± temizle
      setGridBuyPrice('');
      setGridSellPrice('');
      setGridAmount('');

    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : 'Bilinmeyen hata';
      setAutoTradeStatus(`âŒ Grid bot oluÅŸturma hatasÄ±: ${errorMessage}`);
    }
  }, [gridBuyPrice, gridSellPrice, gridAmount, publicKey, isConnected, autoTradeAssetIn, autoTradeAssetOut, botMode, botWallet, transferXLMToBot, connect, getDynamicTradeParams]);



  // ğŸ’¸ Bot kazancÄ±nÄ± ana cÃ¼zdana transfer etme fonksiyonu
  const transferProfitToMainWallet = useCallback(async (
    assetToTransfer: string, 
    fromBotWallet: { publicKey: string; secretKey: string }, 
    toMainWallet: string
  ) => {
    try {
      console.log('ğŸ” Transfer baÅŸlatÄ±lÄ±yor:', {
        assetToTransfer,
        fromBot: fromBotWallet.publicKey,
        toWallet: toMainWallet
      });

      const StellarSdk = await import('@stellar/stellar-sdk');
      
      // Bot account bilgilerini al
      const response = await fetch(`https://horizon-testnet.stellar.org/accounts/${fromBotWallet.publicKey}`);
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Bot account bilgisi alÄ±namadÄ±: ${response.status} - ${errorText}`);
      }
      
      const account = await response.json();
      console.log('ğŸ¤– Bot account balances:', account.balances);
      
      // Transfer edilecek asset balance'Ä±nÄ± bul
      const assetBalance = account.balances.find((balance: any) => {
        if (assetToTransfer.includes('native')) {
          return balance.asset_type === 'native';
        } else {
          // Contract asset iÃ§in - EXACT MATCH Ã¶ncelik
          const assetParts = assetToTransfer.split('_');
          const expectedAssetCode = assetParts[0];
          const expectedAssetIssuer = assetParts[1];
          
          // 1. Ã–nce exact match dene
          if (expectedAssetCode && expectedAssetIssuer && balance.asset_code && balance.asset_issuer) {
            const exactMatch = balance.asset_code === expectedAssetCode && balance.asset_issuer === expectedAssetIssuer;
            if (exactMatch) {
              console.log('âœ… Exact asset match found:', balance.asset_code, balance.asset_issuer);
              return true;
            }
          }
          
          // 2. Asset code match (fallback)
          if (expectedAssetCode && balance.asset_code) {
            const codeMatch = balance.asset_code === expectedAssetCode || 
                             balance.asset_code.includes(expectedAssetCode) ||
                             expectedAssetCode.includes(balance.asset_code);
            console.log('ğŸ” Asset code match check:', { 
              expectedAssetCode,
              balanceAssetCode: balance.asset_code,
              codeMatch
            });
            return codeMatch;
          }
          
          // 3. GeniÅŸ matching (son Ã§are)
          const broadMatch = balance.asset_code && (
            assetToTransfer.includes(balance.asset_code) || 
            balance.asset_code.includes('USDC') ||
            balance.asset_code.includes('USD') ||
            balance.asset_code.includes('STAR') ||
            balance.asset_code.includes('BTC') ||
            balance.asset_code.includes('ETH') ||
            balance.asset_code.includes('XTAR')
          );
          console.log('ğŸ” Broad asset match check:', { 
            balanceAssetCode: balance.asset_code,
            balanceAssetIssuer: balance.asset_issuer,
            assetToTransfer, 
            broadMatch 
          });
          return broadMatch;
        }
      });
      
      console.log('ğŸ’° Found asset balance:', assetBalance);
      
      if (!assetBalance) {
        console.log('âŒ Asset balance bulunamadÄ±! Mevcut balances:');
        account.balances.forEach((bal: any, index: number) => {
          console.log(`  ${index}: ${bal.asset_type === 'native' ? 'XLM (native)' : bal.asset_code} - ${bal.balance} - Issuer: ${bal.asset_issuer || 'N/A'}`);
        });
        console.log('Aranan asset:', assetToTransfer);
        return;
      }
      
      if (parseFloat(assetBalance.balance) < 0.1) {
        console.log('âš ï¸ Transfer iÃ§in yeterli balance yok:', assetBalance);
        return;
      }
      /////murat
      // XLM iÃ§in Stellar minimum account reserve (1 XLM) + iÅŸlem Ã¼creti rezerv et
      const transferAmount = assetToTransfer.includes('native') 
        ? Math.max(0, parseFloat(assetBalance.balance) - 1.5) // 1.5 XLM rezerv: 1 XLM min account + 0.5 XLM fees
        : parseFloat(assetBalance.balance) * 0.99; // %99'unu gÃ¶nder
      
      if (transferAmount <= 0.1) { // Minimum 0.1 transfer gerekli
        console.log('âš ï¸ Transfer miktarÄ± Ã§ok dÃ¼ÅŸÃ¼k:', transferAmount, 'Balance:', assetBalance.balance);
        return;
      }
      
      console.log(`ğŸ“¤ Transfer edilecek: ${transferAmount} ${assetBalance.asset_code || 'XLM'}`);
      
      // Server ve transaction oluÅŸtur
      const server = new StellarSdk.Horizon.Server('https://horizon-testnet.stellar.org');
      const botKeypair = StellarSdk.Keypair.fromSecret(fromBotWallet.secretKey);
      const botAccount = await server.loadAccount(fromBotWallet.publicKey);
      
      // Asset oluÅŸtur
      let asset;
      if (assetToTransfer.includes('native')) {
        asset = StellarSdk.Asset.native();
        console.log('ğŸª™ Native XLM asset oluÅŸturuldu');
      } else {
        // Contract asset iÃ§in issuer bilgisi gerekli
        if (assetBalance.asset_issuer && assetBalance.asset_code) {
          asset = new StellarSdk.Asset(assetBalance.asset_code, assetBalance.asset_issuer);
          console.log('ğŸ¯ Custom asset oluÅŸturuldu:', assetBalance.asset_code, assetBalance.asset_issuer);
        } else {
          console.log('âš ï¸ Asset issuer/code bilgisi eksik, XLM transfer ediliyor');
          asset = StellarSdk.Asset.native();
          // XLM balance'Ä±nÄ± al ve transfer et
          const xlmBalance = account.balances.find((b: any) => b.asset_type === 'native');
          if (xlmBalance && parseFloat(xlmBalance.balance) > 0.5) {
            const xlmTransferAmount = Math.max(0, parseFloat(xlmBalance.balance) - 0.5);
            console.log(`ğŸ“¤ Fallback XLM transfer: ${xlmTransferAmount}`);
          }
        }
      }
      
      // Payment transaction oluÅŸtur
      const transaction = new StellarSdk.TransactionBuilder(botAccount, {
        fee: StellarSdk.BASE_FEE,
        networkPassphrase: StellarSdk.Networks.TESTNET,
      })
      .addOperation(StellarSdk.Operation.payment({
        destination: toMainWallet,
        asset: asset,
        amount: transferAmount.toFixed(7), // Decimal format, stroop deÄŸil
      }))
      .setTimeout(180)
      .build();
      
      // Bot imza at
      transaction.sign(botKeypair);
      
      // GÃ¶nder
      const result = await server.submitTransaction(transaction);
      console.log('âœ… Transfer successful:', result.hash);
      
      return result.hash;
      
    } catch (error: any) {
      console.error('âŒ Transfer profit error:', error);
      
      // Stellar hata kodlarÄ±nÄ± kontrol et
      if (error.response?.data?.extras?.result_codes) {
        const resultCodes = error.response.data.extras.result_codes;
        console.error('Stellar hata kodlarÄ±:', resultCodes);
        throw new Error(`Transfer hatasÄ±: ${JSON.stringify(resultCodes)}`);
      }
      
      throw new Error(`Token transfer hatasÄ±: ${error.message || 'Bilinmeyen hata'}`);
    }
  }, []);

  // ğŸ¤– Bot Otomatik Ä°ÅŸlem Execution (Tam Otomatik)
  const executeBotTrade = useCallback(async (type: 'buy' | 'sell', amount: string, targetPrice: string) => {
    setIsTrading(true);
    
    try {
      setAutoTradeStatus(`ğŸ¤– Bot ${type === 'buy' ? 'alÄ±m' : 'satÄ±m'} baÅŸlatÄ±lÄ±yor...`);

      // Bot mode kontrolÃ¼ ve validasyon
      const usingBotWallet = botMode === 'auto' && botWallet;
      const signerKey = usingBotWallet ? botWallet.publicKey : publicKey;
      
      if (!signerKey) {
        throw new Error('CÃ¼zdan baÄŸlÄ± deÄŸil.');
      }

      // Bot wallet kullanÄ±lÄ±yorsa balance kontrolÃ¼
      if (usingBotWallet) {
        if (botBalance < 1) { // Minimum 1 XLM gerekli
          throw new Error(`Bot cÃ¼zdanÄ±nda yetersiz bakiye. Mevcut: ${botBalance.toFixed(2)} XLM, Minimum: 1 XLM gerekli.`);
        }
        setAutoTradeStatus(`ğŸ¤– Bot wallet kullanÄ±lÄ±yor: ${botWallet.publicKey.slice(0, 10)}...`);
      } else {
        setAutoTradeStatus(`ğŸ‘¤ Ana wallet kullanÄ±lÄ±yor: ${publicKey?.slice(0, 10)}...`);
      }

      const numAmount = parseFloat(amount);
      if (isNaN(numAmount) || numAmount < 1) {
        throw new Error('Minimum 1 asset gereklidir.');
      }

      setAutoTradeStatus(`ğŸ“Š Soroswap API'den quote alÄ±nÄ±yor...`);

      // Dinamik trade parametrelerini al (Ana sayfa ile aynÄ±)
      const assetInAddress = type === 'buy' ? autoTradeAssetIn : autoTradeAssetOut;
      const assetOutAddress = type === 'buy' ? autoTradeAssetOut : autoTradeAssetIn;
      const { maxHops, slippageBps } = getDynamicTradeParams(assetInAddress, assetOutAddress);

      // Soroswap API quote al (Ana sayfa ile aynÄ± parametreler) - RETRY MEKANÄ°ZMASI
      let quoteResponse: any;
      let retryCount = 0;
      const maxRetries = 3;
      
      while (retryCount < maxRetries) {
        try {
          setAutoTradeStatus(`ğŸ“Š Soroswap API'den quote alÄ±nÄ±yor... (Deneme ${retryCount + 1}/${maxRetries})`);
          
          quoteResponse = await Promise.race([
            soroswapAPI.getQuote({
              assetIn: assetInAddress,
              assetOut: assetOutAddress,
              amount: toStroop(amount), // Ana sayfa ile aynÄ± format
              tradeType: 'EXACT_IN' as const,
              protocols: DEFAULT_PROTOCOLS,
              slippageBps: slippageBps, // Dinamik slippage
              feeBps: 50,
              parts: 1,
              maxHops: maxHops // Dinamik maxHops
            }),
            new Promise((_, reject) => 
              setTimeout(() => reject(new Error(`Quote API timeout (${30 + (retryCount * 10)} saniye)`)), 30000 + (retryCount * 10000))
            )
          ]) as any;
          
          // BaÅŸarÄ±lÄ± olursa dÃ¶ngÃ¼den Ã§Ä±k
          break;
          
        } catch (quoteError) {
          retryCount++;
          console.error(`Quote deneme ${retryCount} hatasÄ±:`, quoteError);
          
          if (retryCount >= maxRetries) {
            throw new Error(`Quote API ${maxRetries} deneme sonrasÄ± baÅŸarÄ±sÄ±z: ${quoteError instanceof Error ? quoteError.message : 'Bilinmeyen hata'}`);
          }
          
          // Bir sonraki deneme iÃ§in bekle
          setAutoTradeStatus(`â³ Quote hatasÄ±, ${2 * retryCount} saniye sonra tekrar denenecek...`);
          await new Promise(resolve => setTimeout(resolve, 2000 * retryCount));
        }
      }

      if (!quoteResponse.assetIn || !quoteResponse.assetOut) {
        throw new Error(`Quote alma hatasÄ±: Invalid quote response`);
      }

      setAutoTradeStatus(`ğŸ”— Transaction oluÅŸturuluyor...`);

      // Build transaction (Ana sayfa ile aynÄ± mantÄ±k) - RETRY MEKANÄ°ZMASI
      console.log('ğŸ”¨ Building transaction for user:', signerKey);
      let buildResponse: any;
      retryCount = 0;
      
      while (retryCount < maxRetries) {
        try {
          setAutoTradeStatus(`ğŸ”— Transaction oluÅŸturuluyor... (Deneme ${retryCount + 1}/${maxRetries})`);
          
          buildResponse = await Promise.race([
            soroswapAPI.buildTransaction({
              quote: quoteResponse,
              referralId: "GALAXYVOIDAOPZTDLHILAJQKCVVFMD4IKLXLSZV5YHO7VY74IWZILUTO",
              sponsor: "GDISPX62G6EGBZX3I2VMB4J3O3CPFHHRAJ4QZNOYVXYVHJ6BVRL2A3Y3",
              from: signerKey // KullanÄ±cÄ±nÄ±n veya bot'un wallet adresi
            }),
            new Promise((_, reject) => 
              setTimeout(() => reject(new Error(`Build transaction timeout (${30 + (retryCount * 10)} saniye)`)), 30000 + (retryCount * 10000))
            )
          ]) as any;
          
          // BaÅŸarÄ±lÄ± olursa dÃ¶ngÃ¼den Ã§Ä±k
          break;
          
        } catch (buildError) {
          retryCount++;
          console.error(`Build transaction deneme ${retryCount} hatasÄ±:`, buildError);
          
          if (retryCount >= maxRetries) {
            throw new Error(`Build transaction ${maxRetries} deneme sonrasÄ± baÅŸarÄ±sÄ±z: ${buildError instanceof Error ? buildError.message : 'Bilinmeyen hata'}`);
          }
          
          // Bir sonraki deneme iÃ§in bekle
          setAutoTradeStatus(`â³ Transaction build hatasÄ±, ${2 * retryCount} saniye sonra tekrar denenecek...`);
          await new Promise(resolve => setTimeout(resolve, 2000 * retryCount));
        }
      }

      if (!buildResponse.xdr) {
        throw new Error(`Build transaction hatasÄ±: No XDR received`);
      }
      console.log('âœ… Transaction built successfully:', buildResponse);

      setAutoTradeStatus(`ğŸ” ${usingBotWallet ? 'Bot otomatik imza atÄ±yor' : 'KullanÄ±cÄ± imzasÄ± bekleniyor'}...`);

      let signedXDR: string;

      if (usingBotWallet) {
        // ğŸ¤– Bot otomatik imza
        const StellarSdk = await import('@stellar/stellar-sdk');
        const botKeypair = StellarSdk.Keypair.fromSecret(botWallet.secretKey);
        const transaction = new StellarSdk.Transaction(buildResponse.xdr, StellarSdk.Networks.TESTNET);
        transaction.sign(botKeypair);
        signedXDR = transaction.toEnvelope().toXDR('base64');
        
        setAutoTradeStatus(`âœ… Bot imzasÄ± tamamlandÄ±, transaction gÃ¶nderiliyor...`);
      } else {
        // ğŸ‘¤ KullanÄ±cÄ± manuel imza (Ana sayfa ile aynÄ± mantÄ±k)
        console.log('ğŸ” Signing transaction XDR:', buildResponse.xdr);
        const signedXdr = await signTransaction(buildResponse.xdr);
        
        console.log('âœ… Signed XDR received:', typeof signedXdr, signedXdr);
        
        // SignedXDR'Ä±n string olduÄŸundan emin ol (Ana sayfa ile aynÄ±)
        if (typeof signedXdr === 'string') {
          signedXDR = signedXdr;
        } else if (signedXdr && typeof signedXdr === 'object' && 'signedTxXdr' in signedXdr) {
          signedXDR = (signedXdr as { signedTxXdr: string }).signedTxXdr;
          console.log('ğŸ”§ Extracted signedTxXdr from object:', signedXDR);
        } else {
          throw new Error(`Invalid signed XDR format: ${JSON.stringify(signedXdr)}`);
        }
        
        if (!signedXDR || signedXDR.trim() === '') {
          throw new Error('Signed XDR is empty or invalid');
        }
        
        console.log('ğŸ“¤ Ready to send transaction with XDR:', signedXDR.substring(0, 100) + '...');
      }
      
      setAutoTradeStatus(`ğŸ“¤ Transaction gÃ¶nderiliyor...`);

      // Submit transaction - RETRY MEKANÄ°ZMASI
      let submitResponse: any;
      retryCount = 0;
      
      while (retryCount < maxRetries) {
        try {
          setAutoTradeStatus(`ğŸ“¤ Transaction gÃ¶nderiliyor... (Deneme ${retryCount + 1}/${maxRetries})`);
          
          submitResponse = await Promise.race([
            soroswapAPI.sendTransaction({ xdr: signedXDR }),
            new Promise((_, reject) => 
              setTimeout(() => reject(new Error(`Send transaction timeout (${45 + (retryCount * 15)} saniye)`)), 45000 + (retryCount * 15000))
            )
          ]) as any;
          
          // BaÅŸarÄ±lÄ± olursa dÃ¶ngÃ¼den Ã§Ä±k
          break;
          
        } catch (submitError) {
          retryCount++;
          console.error(`Submit transaction deneme ${retryCount} hatasÄ±:`, submitError);
          
          if (retryCount >= maxRetries) {
            throw new Error(`Submit transaction ${maxRetries} deneme sonrasÄ± baÅŸarÄ±sÄ±z: ${submitError instanceof Error ? submitError.message : 'Bilinmeyen hata'}`);
          }
          
          // Bir sonraki deneme iÃ§in bekle
          setAutoTradeStatus(`â³ Transaction submit hatasÄ±, ${3 * retryCount} saniye sonra tekrar denenecek...`);
          await new Promise(resolve => setTimeout(resolve, 3000 * retryCount));
        }
      }
      
      if (!submitResponse.hash && !submitResponse.status) {
        throw new Error(`Transaction submission hatasÄ±: No hash received`);
      }

      const assetInSymbol = ASSET_OPTIONS.find(a => a.value === (type === 'buy' ? autoTradeAssetIn : autoTradeAssetOut))?.symbol || 'Unknown';
      const assetOutSymbol = ASSET_OPTIONS.find(a => a.value === (type === 'buy' ? autoTradeAssetOut : autoTradeAssetIn))?.symbol || 'Unknown';

      setAutoTradeStatus(`âœ… Bot ${type === 'buy' ? 'alÄ±m' : 'satÄ±m'} baÅŸarÄ±lÄ±!
ğŸ¤– Otomatik Ä°ÅŸlem TamamlandÄ±
ğŸ’° Miktar: ${amount} ${assetInSymbol}
ğŸ“Š Pair: ${assetInSymbol}/${assetOutSymbol}
ğŸ’µ Fiyat: $${displayPrice.toFixed(4)}
ğŸ†” Hash: ${submitResponse.hash || 'N/A'}`);

      // ğŸ¯ Bot iÅŸlem sonrasÄ± aldÄ±ÄŸÄ± token'larÄ± kullanÄ±cÄ±nÄ±n cÃ¼zdanÄ±na transfer et
      if (usingBotWallet && customWalletAddress && botWallet) {
        try {
          setAutoTradeStatus(prev => `${prev}\n\nğŸ’¸ AldÄ±ÄŸÄ±nÄ±z token'lar ${customWalletAddress.slice(0, 10)}... adresine transfer ediliyor...`);
          
          // Ä°ÅŸlem sonrasÄ± bot balance'Ä±nÄ± tekrar kontrol et
          await new Promise(resolve => setTimeout(resolve, 3000)); // 3 saniye bekle
          
          const postTradeResponse = await fetch(`https://horizon-testnet.stellar.org/accounts/${botWallet.publicKey}`);
          if (postTradeResponse.ok) {
            const postTradeAccount = await postTradeResponse.json();
            console.log('ğŸ“Š Ä°ÅŸlem sonrasÄ± bot balances:', postTradeAccount.balances);
            
            // AldÄ±ÄŸÄ±mÄ±z asset'i bul (iÅŸlem sonucunda aldÄ±ÄŸÄ±mÄ±z token)
            const targetAssetValue = type === 'buy' ? autoTradeAssetOut : autoTradeAssetIn; // Buy'da USDC/XSTAR, Sell'de XLM
            const targetAssetInfo = ASSET_OPTIONS.find(a => a.value === targetAssetValue);
            console.log('ğŸ¯ Hedef transfer asset:', { targetAssetValue, targetAssetInfo });
            
            // Bu asset'in bot wallet'Ä±ndaki balance'Ä±nÄ± bul
            const targetAssetBalance = postTradeAccount.balances.find((balance: any) => {
              if (targetAssetValue.includes('native') || targetAssetValue.includes('XLM') || targetAssetInfo?.symbol === 'XLM') {
                console.log('ğŸª™ XLM asset aranÄ±yor, balance:', balance.asset_type, balance.balance);
                return balance.asset_type === 'native';
              } else {
                // Contract asset iÃ§in - asset symbol ile eÅŸleÅŸtir
                const targetSymbol = targetAssetInfo?.symbol;
                console.log('ğŸ” Asset balance check:', {
                  targetSymbol,
                  balanceAssetCode: balance.asset_code,
                  balanceAssetType: balance.asset_type,
                  balanceAmount: balance.balance
                });
                
                return balance.asset_code && targetSymbol && (
                  balance.asset_code === targetSymbol ||
                  balance.asset_code.includes(targetSymbol) ||
                  targetSymbol.includes(balance.asset_code) ||
                  // Common asset matches
                  (targetSymbol === 'USDC' && balance.asset_code.includes('USD')) ||
                  (targetSymbol === 'XTAR' && balance.asset_code.includes('STAR')) ||
                  (targetSymbol === 'BTC' && balance.asset_code.includes('BTC')) ||
                  (targetSymbol === 'ETH' && balance.asset_code.includes('ETH'))
                );
              }
            });
            
            console.log('ğŸ’° Bulunan hedef asset balance:', targetAssetBalance);
            
            if (targetAssetBalance && parseFloat(targetAssetBalance.balance) > (targetAssetBalance.asset_type === 'native' ? 2.0 : 0.1)) {
              // Hedef asset'i transfer et
              const assetIdentifier = targetAssetBalance.asset_type === 'native' 
                ? 'native' 
                : `${targetAssetBalance.asset_code}_${targetAssetBalance.asset_issuer || ''}`;
              
              console.log('ğŸ“¤ Transfer edilecek asset ID:', assetIdentifier);
              
              const transferHash = await transferProfitToMainWallet(
                assetIdentifier,
                botWallet,
                customWalletAddress
              );
              
              setAutoTradeStatus(prev => `${prev}\nâœ… ${targetAssetBalance.asset_code || 'XLM'} cÃ¼zdanÄ±nÄ±za transfer edildi!
ğŸ’¸ Transfer Hash: ${transferHash || 'N/A'}`);
            } else {
              // Hedef asset bulunamazsa en yÃ¼ksek balance'lÄ± asset'i transfer et
              console.log('âš ï¸ Hedef asset bulunamadÄ±, en yÃ¼ksek balance transfer ediliyor');
              
              const transferableAssets = postTradeAccount.balances.filter((balance: any) => 
                parseFloat(balance.balance) > (balance.asset_type === 'native' ? 2.0 : 0.1) // XLM iÃ§in 2.0, diÄŸerleri iÃ§in 0.1
              );
              
              if (transferableAssets.length > 0) {
                const highestBalance = transferableAssets.reduce((prev: any, current: any) => 
                  parseFloat(current.balance) > parseFloat(prev.balance) ? current : prev
                );
                
                const assetIdentifier = highestBalance.asset_type === 'native' 
                  ? 'native' 
                  : `${highestBalance.asset_code}_${highestBalance.asset_issuer}`;
                
                const transferHash = await transferProfitToMainWallet(
                  assetIdentifier,
                  botWallet,
                  customWalletAddress
                );
                
                setAutoTradeStatus(prev => `${prev}\nâœ… ${highestBalance.asset_code || 'XLM'} cÃ¼zdanÄ±nÄ±za transfer edildi!
ğŸ’¸ Transfer Hash: ${transferHash || 'N/A'}`);
              } else {
                setAutoTradeStatus(prev => `${prev}\nâš ï¸ Transfer edilebilir asset bulunamadÄ±`);
              }
            }
          }
          
        } catch (transferError) {
          const transferErrorMsg = transferError instanceof Error ? transferError.message : 'Transfer hatasÄ±';
          setAutoTradeStatus(prev => `${prev}\nâš ï¸ Transfer hatasÄ±: ${transferErrorMsg}`);
          console.error('Token transfer hatasÄ±:', transferError);
        }
      }

      // Telegram bildirimi
      if (telegramBot && telegramChatId) {
        const message = `ğŸ¤– BOT OTOMATÄ°K TRADE!
âœ… ${type === 'buy' ? `ğŸ’° ${assetOutSymbol} ALIM` : `ğŸ’¸ ${assetInSymbol} SATIM`} BAÅARILI
ğŸ¤– Pre-authorized Ä°ÅŸlem TamamlandÄ±
ğŸ“Š Tetiklenen: $${targetPrice}
ğŸ’µ GerÃ§ekleÅŸen: $${displayPrice.toFixed(4)}
ğŸ’° Harcanan: ${amount} ${assetInSymbol}
${usingBotWallet ? `ğŸ’¸ AldÄ±ÄŸÄ±nÄ±z ${type === 'buy' ? assetOutSymbol : assetInSymbol} token'larÄ± cÃ¼zdanÄ±nÄ±za transfer edildi!
ğŸ¦ Transfer Adresi: ${customWalletAddress.slice(0, 10)}...${customWalletAddress.slice(-10)}` : ''}
ğŸ†” Trade Hash: ${submitResponse.hash || 'N/A'}
â° ${new Date().toLocaleString('tr-TR')}`;
        
        await telegramBot.sendMessage(telegramChatId, message);
      }

      // Reset deÄŸerler
      if (type === 'buy') {
        setBuyTargetPrice('');
        setAutoBuyAmount('');
        setPreAuthBuyOrder(null);
        localStorage.removeItem(`preauth_buy_${publicKey}`);
      } else {
        setSellTargetPrice('');
        setAutoSellAmount('');
        setPreAuthSellOrder(null);
        localStorage.removeItem(`preauth_sell_${publicKey}`);
      }
      
      setHasAutoTradeError(false);
      
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : 'Bilinmeyen hata';
      setAutoTradeStatus(`âŒ Bot ${type === 'buy' ? 'alÄ±m' : 'satÄ±m'} hatasÄ±: ${errorMessage}
      
ğŸ¤– BOT Ä°ÅLEM DURDURULDU
Manuel olarak tekrar aktifleÅŸtirin.`);
      
      setHasAutoTradeError(true);
      setIsAutoTradingEnabled(false);
      
      // Reset deÄŸerler hata durumunda da
      if (type === 'buy') {
        setBuyTargetPrice('');
        setAutoBuyAmount('');
        setPreAuthBuyOrder(null);
        localStorage.removeItem(`preauth_buy_${publicKey}`);
      } else {
        setSellTargetPrice('');
        setAutoSellAmount('');
        setPreAuthSellOrder(null);
        localStorage.removeItem(`preauth_sell_${publicKey}`);
      }
      
      // Telegram hata bildirimi
      if (telegramBot && telegramChatId) {
        const message = `ğŸš¨ BOT Ä°ÅLEM HATASI!
âŒ ${type === 'buy' ? 'ALIM' : 'SATIM'} BAÅARISIZ
ğŸ¤– Bot Ä°ÅŸlem Durduruldu
ğŸ“Š Hedef: $${targetPrice}
ğŸ’µ GÃ¼ncel: $${displayPrice.toFixed(4)}
âš ï¸ Hata: ${errorMessage}
â° ${new Date().toLocaleString('tr-TR')}`;
        
        await telegramBot.sendMessage(telegramChatId, message);
      }
    } finally {
      setIsTrading(false);
    }
  }, [publicKey, signTransaction, displayPrice, telegramBot, telegramChatId, autoTradeAssetIn, autoTradeAssetOut, botMode, botWallet, botBalance, transferProfitToMainWallet, customWalletAddress, getDynamicTradeParams]);

  // ğŸ¤– Grid Bot Ã–zel Ä°ÅŸlem Execution (AlÄ±mda Transfer YOK, SatÄ±mda Transfer VAR)
  const executeGridBotTrade = useCallback(async (type: 'buy' | 'sell', amount: string, targetPrice: string, transferAfterTrade = false) => {
    setIsTrading(true);
    
    try {
      setAutoTradeStatus(`ğŸ¤– Grid Bot ${type === 'buy' ? 'alÄ±m' : 'satÄ±m'} baÅŸlatÄ±lÄ±yor...`);

      // Bot mode kontrolÃ¼ ve validasyon
      const usingBotWallet = botMode === 'auto' && botWallet;
      const signerKey = usingBotWallet ? botWallet.publicKey : publicKey;
      
      if (!signerKey) {
        throw new Error('CÃ¼zdan baÄŸlÄ± deÄŸil.');
      }

      // Bot wallet kullanÄ±lÄ±yorsa balance kontrolÃ¼
      if (usingBotWallet) {
        if (botBalance < 1) { // Minimum 1 XLM gerekli
          throw new Error(`Bot cÃ¼zdanÄ±nda yetersiz bakiye. Mevcut: ${botBalance.toFixed(2)} XLM, Minimum: 1 XLM gerekli.`);
        }
        setAutoTradeStatus(`ğŸ¤– Grid Bot wallet kullanÄ±lÄ±yor: ${botWallet.publicKey.slice(0, 10)}...`);
      } else {
        setAutoTradeStatus(`ğŸ‘¤ Grid Bot ana wallet kullanÄ±lÄ±yor: ${publicKey?.slice(0, 10)}...`);
      }

      const numAmount = parseFloat(amount);
      if (isNaN(numAmount) || numAmount < 1) {
        throw new Error('Minimum 1 asset gereklidir.');
      }

      setAutoTradeStatus(`ğŸ“Š Grid Bot iÃ§in Soroswap API'den quote alÄ±nÄ±yor...`);

      // Dinamik trade parametrelerini al
      const assetInAddress = type === 'buy' ? autoTradeAssetIn : autoTradeAssetOut;
      const assetOutAddress = type === 'buy' ? autoTradeAssetOut : autoTradeAssetIn;
      const { maxHops, slippageBps } = getDynamicTradeParams(assetInAddress, assetOutAddress);

      // Soroswap API quote al - RETRY MEKANÄ°ZMASI
      let quoteResponse: any;
      let retryCount = 0;
      const maxRetries = 3;
      
      while (retryCount < maxRetries) {
        try {
          setAutoTradeStatus(`ğŸ“Š Grid Bot quote alÄ±nÄ±yor... (Deneme ${retryCount + 1}/${maxRetries})`);
          
          quoteResponse = await Promise.race([
            soroswapAPI.getQuote({
              assetIn: assetInAddress,
              assetOut: assetOutAddress,
              amount: toStroop(amount),
              tradeType: 'EXACT_IN' as const,
              protocols: DEFAULT_PROTOCOLS,
              slippageBps: slippageBps,
              feeBps: 50,
              parts: 1,
              maxHops: maxHops
            }),
            new Promise((_, reject) => 
              setTimeout(() => reject(new Error(`Grid Bot quote timeout (${30 + (retryCount * 10)} saniye)`)), 30000 + (retryCount * 10000))
            )
          ]) as any;
          
          break;
          
        } catch (quoteError) {
          retryCount++;
          console.error(`Grid Bot quote deneme ${retryCount} hatasÄ±:`, quoteError);
          
          if (retryCount >= maxRetries) {
            throw new Error(`Grid Bot quote API ${maxRetries} deneme sonrasÄ± baÅŸarÄ±sÄ±z: ${quoteError instanceof Error ? quoteError.message : 'Bilinmeyen hata'}`);
          }
          
          setAutoTradeStatus(`â³ Grid Bot quote hatasÄ±, ${2 * retryCount} saniye sonra tekrar denenecek...`);
          await new Promise(resolve => setTimeout(resolve, 2000 * retryCount));
        }
      }

      if (!quoteResponse.assetIn || !quoteResponse.assetOut) {
        throw new Error(`Grid Bot quote alma hatasÄ±: Invalid quote response`);
      }

      setAutoTradeStatus(`ğŸ”— Grid Bot transaction oluÅŸturuluyor...`);

      // Build transaction - RETRY MEKANÄ°ZMASI
      let buildResponse: any;
      retryCount = 0;
      
      while (retryCount < maxRetries) {
        try {
          setAutoTradeStatus(`ğŸ”— Grid Bot transaction oluÅŸturuluyor... (Deneme ${retryCount + 1}/${maxRetries})`);
          
          buildResponse = await Promise.race([
            soroswapAPI.buildTransaction({
              quote: quoteResponse,
              referralId: "GALAXYVOIDAOPZTDLHILAJQKCVVFMD4IKLXLSZV5YHO7VY74IWZILUTO",
              sponsor: "GDISPX62G6EGBZX3I2VMB4J3O3CPFHHRAJ4QZNOYVXYVHJ6BVRL2A3Y3",
              from: signerKey
            }),
            new Promise((_, reject) => 
              setTimeout(() => reject(new Error(`Grid Bot build timeout (${30 + (retryCount * 10)} saniye)`)), 30000 + (retryCount * 10000))
            )
          ]) as any;
          
          break;
          
        } catch (buildError) {
          retryCount++;
          console.error(`Grid Bot build deneme ${retryCount} hatasÄ±:`, buildError);
          
          if (retryCount >= maxRetries) {
            throw new Error(`Grid Bot build transaction ${maxRetries} deneme sonrasÄ± baÅŸarÄ±sÄ±z: ${buildError instanceof Error ? buildError.message : 'Bilinmeyen hata'}`);
          }
          
          setAutoTradeStatus(`â³ Grid Bot transaction build hatasÄ±, ${2 * retryCount} saniye sonra tekrar denenecek...`);
          await new Promise(resolve => setTimeout(resolve, 2000 * retryCount));
        }
      }

      if (!buildResponse.xdr) {
        throw new Error(`Grid Bot build transaction hatasÄ±: No XDR received`);
      }

      setAutoTradeStatus(`ğŸ” Grid Bot ${usingBotWallet ? 'otomatik imza atÄ±yor' : 'kullanÄ±cÄ± imzasÄ± bekleniyor'}...`);

      let signedXDR: string;

      if (usingBotWallet) {
        // Bot otomatik imza
        const StellarSdk = await import('@stellar/stellar-sdk');
        const botKeypair = StellarSdk.Keypair.fromSecret(botWallet.secretKey);
        const transaction = new StellarSdk.Transaction(buildResponse.xdr, StellarSdk.Networks.TESTNET);
        transaction.sign(botKeypair);
        signedXDR = transaction.toEnvelope().toXDR('base64');
        
        setAutoTradeStatus(`âœ… Grid Bot imzasÄ± tamamlandÄ±, transaction gÃ¶nderiliyor...`);
      } else {
        // KullanÄ±cÄ± manuel imza
        const signedXdr = await signTransaction(buildResponse.xdr);
        
        if (typeof signedXdr === 'string') {
          signedXDR = signedXdr;
        } else if (signedXdr && typeof signedXdr === 'object' && 'signedTxXdr' in signedXdr) {
          signedXDR = (signedXdr as any).signedTxXdr;
        } else {
          throw new Error('Invalid signed XDR format received from Freighter');
        }
        
        if (!signedXDR || signedXDR.trim() === '') {
          throw new Error('Empty signed XDR received from Freighter');
        }
      }
      
      setAutoTradeStatus(`ğŸ“¤ Grid Bot transaction gÃ¶nderiliyor...`);

      // Submit transaction - RETRY MEKANÄ°ZMASI
      let submitResponse: any;
      retryCount = 0;
      
      while (retryCount < maxRetries) {
        try {
          setAutoTradeStatus(`ğŸ“¤ Grid Bot transaction gÃ¶nderiliyor... (Deneme ${retryCount + 1}/${maxRetries})`);
          
          submitResponse = await Promise.race([
            soroswapAPI.sendTransaction({ xdr: signedXDR }),
            new Promise((_, reject) => 
              setTimeout(() => reject(new Error(`Grid Bot send timeout (${45 + (retryCount * 15)} saniye)`)), 45000 + (retryCount * 15000))
            )
          ]) as any;
          
          break;
          
        } catch (submitError) {
          retryCount++;
          console.error(`Grid Bot submit deneme ${retryCount} hatasÄ±:`, submitError);
          
          if (retryCount >= maxRetries) {
            throw new Error(`Grid Bot submit transaction ${maxRetries} deneme sonrasÄ± baÅŸarÄ±sÄ±z: ${submitError instanceof Error ? submitError.message : 'Bilinmeyen hata'}`);
          }
          
          setAutoTradeStatus(`â³ Grid Bot transaction submit hatasÄ±, ${3 * retryCount} saniye sonra tekrar denenecek...`);
          await new Promise(resolve => setTimeout(resolve, 3000 * retryCount));
        }
      }
      
      if (!submitResponse.hash && !submitResponse.status) {
        throw new Error(`Grid Bot transaction submission hatasÄ±: No hash received`);
      }

      const assetInSymbol = ASSET_OPTIONS.find(a => a.value === (type === 'buy' ? autoTradeAssetIn : autoTradeAssetOut))?.symbol || 'Unknown';
      const assetOutSymbol = ASSET_OPTIONS.find(a => a.value === (type === 'buy' ? autoTradeAssetOut : autoTradeAssetIn))?.symbol || 'Unknown';

      let statusMessage = `âœ… Grid Bot ${type === 'buy' ? 'alÄ±m' : 'satÄ±m'} baÅŸarÄ±lÄ±!
ğŸ¤– Grid Bot Ä°ÅŸlem TamamlandÄ±
ğŸ’° Miktar: ${amount} ${assetInSymbol}
ğŸ“Š Pair: ${assetInSymbol}/${assetOutSymbol}
ğŸ’µ Fiyat: $${displayPrice.toFixed(4)}
ğŸ†” Hash: ${submitResponse.hash || 'N/A'}`;

      // ğŸ¯ Transfer mantÄ±ÄŸÄ±: Sadece transferAfterTrade true ise (satÄ±m) transfer yap
      if (transferAfterTrade && usingBotWallet && customWalletAddress && botWallet) {
        try {
          setAutoTradeStatus(statusMessage + `\nğŸ”„ KazanÃ§ ana cÃ¼zdana transfer ediliyor...`);
          
          // 3 saniye bekle transaction'Ä±n confirm olmasÄ± iÃ§in
          await new Promise(resolve => setTimeout(resolve, 3000));
          
          // Bot account'unu yeniden sorgula
          const response = await fetch(`https://horizon-testnet.stellar.org/accounts/${botWallet.publicKey}`);
          if (response.ok) {
            const postTradeAccount = await response.json();
            
            // Transfer edilecek asset'i belirle (satÄ±m sonrasÄ± alÄ±nan asset)
            const targetAssetValue = type === 'sell' ? autoTradeAssetOut : autoTradeAssetIn;
            const targetAssetInfo = ASSET_OPTIONS.find(a => a.value === targetAssetValue);
            
            // Hedef asset balance'Ä±nÄ± bul
            const targetAssetBalance = postTradeAccount.balances.find((balance: any) => {
              if (targetAssetValue.includes('native')) {
                return balance.asset_type === 'native';
              } else {
                const targetSymbol = targetAssetInfo?.symbol;
                return balance.asset_code && targetSymbol && (
                  balance.asset_code === targetSymbol ||
                  balance.asset_code.includes(targetSymbol) ||
                  targetSymbol.includes(balance.asset_code)
                );
              }
            });
            
            if (targetAssetBalance && parseFloat(targetAssetBalance.balance) > 0.1) {
              const assetIdentifier = targetAssetBalance.asset_type === 'native' 
                ? 'native' 
                : `${targetAssetBalance.asset_code}_${targetAssetBalance.asset_issuer || ''}`;
              
              const transferHash = await transferProfitToMainWallet(
                assetIdentifier,
                botWallet,
                customWalletAddress
              );
              
              statusMessage += `\nâœ… KazanÃ§ cÃ¼zdanÄ±nÄ±za transfer edildi!
ğŸ’¸ Transfer Hash: ${transferHash || 'N/A'}`;
            } else {
              statusMessage += `\nâš ï¸ Transfer edilebilir ${targetAssetInfo?.symbol} bulunamadÄ±`;
            }
          }
        } catch (transferError) {
          console.error('Grid Bot transfer hatasÄ±:', transferError);
          statusMessage += `\nâš ï¸ Transfer hatasÄ±: ${transferError}`;
        }
      } else if (type === 'buy') {
        statusMessage += `\nğŸ¦ AlÄ±nan tokenlar bot cÃ¼zdanÄ±nda tutuluyor (satÄ±m iÃ§in hazÄ±r)`;
      }

      setAutoTradeStatus(statusMessage);

      // Telegram bildirimi
      if (telegramBot && telegramChatId) {
        const message = `ğŸ¤– Grid Bot ${type === 'buy' ? 'AlÄ±m' : 'SatÄ±m'} BaÅŸarÄ±lÄ±! 

ğŸ’° Miktar: ${amount} ${assetInSymbol}
ğŸ’µ Fiyat: $${displayPrice.toFixed(4)}
ğŸ†” Hash: ${submitResponse.hash || 'N/A'}
${transferAfterTrade ? 'ğŸ’¸ KazanÃ§ cÃ¼zdanÄ±nÄ±za transfer edildi!' : 'ğŸ¦ Tokenlar bot cÃ¼zdanÄ±nda tutuluyor'}
â° ${new Date().toLocaleString('tr-TR')}`;
        
        await telegramBot.sendMessage(telegramChatId, message);
      }
      
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : 'Bilinmeyen hata';
      console.error('Grid Bot iÅŸlem hatasÄ±:', error);
      
      setAutoTradeStatus(`âŒ Grid Bot ${type === 'buy' ? 'alÄ±m' : 'satÄ±m'} hatasÄ±: ${errorMessage}
ğŸ¤– Grid Bot Ä°ÅŸlem Durduruldu
ğŸ“Š Hedef: $${targetPrice}
ğŸ’µ GÃ¼ncel: $${displayPrice.toFixed(4)}
âš ï¸ Hata: ${errorMessage}
â° ${new Date().toLocaleString('tr-TR')}`);
      
      // Telegram hata bildirimi
      if (telegramBot && telegramChatId) {
        const message = `âŒ Grid Bot ${type === 'buy' ? 'AlÄ±m' : 'SatÄ±m'} HatasÄ±!

ğŸ¤– Grid Bot Ä°ÅŸlem Durduruldu
ğŸ“Š Hedef: $${targetPrice}
ğŸ’µ GÃ¼ncel: $${displayPrice.toFixed(4)}
âš ï¸ Hata: ${errorMessage}
â° ${new Date().toLocaleString('tr-TR')}`;
        
        await telegramBot.sendMessage(telegramChatId, message);
      }
    } finally {
      setIsTrading(false);
    }
  }, [publicKey, signTransaction, displayPrice, telegramBot, telegramChatId, autoTradeAssetIn, autoTradeAssetOut, botMode, botWallet, botBalance, transferProfitToMainWallet, customWalletAddress, getDynamicTradeParams]);



  // ğŸ¯ Fiyat BazlÄ± Otomatik Ä°ÅŸlem KontrolÃ¼ - Pre-Auth Version
  useEffect(() => {
    const checkPreAuthTrade = async () => {
      if (isTrading || hasAutoTradeError || !isAutoTradingEnabled || !isConnected || displayPrice === 0) {
        return;
      }

      const now = new Date();
      if (lastAutoTradeCheck.current && (now.getTime() - lastAutoTradeCheck.current.getTime()) < 3000) {
        return;
      }
      lastAutoTradeCheck.current = now;

      try {
        // ğŸ¯ Pre-Auth AlÄ±m kontrolÃ¼
        if (preAuthBuyOrder && now < preAuthBuyOrder.expiry && 
            displayPrice <= parseFloat(preAuthBuyOrder.targetPrice) && !isTrading) {
          
          setAutoTradeStatus(`ğŸ¯ Pre-auth alÄ±m tetiklendi! $${displayPrice.toFixed(4)} <= $${preAuthBuyOrder.targetPrice}`);
          
          await executeBotTrade('buy', preAuthBuyOrder.amount, preAuthBuyOrder.targetPrice);
        }
        // ğŸ¯ Pre-Auth SatÄ±m kontrolÃ¼
        else if (preAuthSellOrder && now < preAuthSellOrder.expiry && 
                 displayPrice >= parseFloat(preAuthSellOrder.targetPrice) && !isTrading) {
          
          setAutoTradeStatus(`ğŸ¯ Pre-auth satÄ±m tetiklendi! $${displayPrice.toFixed(4)} >= $${preAuthSellOrder.targetPrice}`);
          
          await executeBotTrade('sell', preAuthSellOrder.amount, preAuthSellOrder.targetPrice);
        }
        
        // ğŸ¤– Grid Trading Bot kontrolÃ¼
        if (gridTradingBot && now < gridTradingBot.expiry && gridTradingBot.isActive && !isTrading) {
          
          if (gridTradingBot.currentStep === 'waiting_buy' && 
              displayPrice <= parseFloat(gridTradingBot.buyPrice)) {
            
            setAutoTradeStatus(`ğŸ¤– Grid Bot: AlÄ±m tetiklendi! $${displayPrice.toFixed(4)} â‰¤ $${gridTradingBot.buyPrice} (eÅŸit veya altÄ±nda)`);
            
            // AlÄ±m iÅŸlemini gerÃ§ekleÅŸtir (Transfer YOK - bot cÃ¼zdanÄ±nda kalacak)
            await executeGridBotTrade('buy', gridTradingBot.amount, gridTradingBot.buyPrice, false);
            
            // Grid bot'u satÄ±m aÅŸamasÄ±na geÃ§ir
            const updatedGridBot = {
              ...gridTradingBot,
              currentStep: 'waiting_sell' as const,
              buyHash: 'completed',
              status: `âœ… GRID BOT - ALIM TAMAMLANDI!
ğŸ”„ Ä°ÅLEM SIRASI GÃœNCELLENDÄ°:
1ï¸âƒ£ ALIM AÅAMASI: âœ… TAMAMLANDI!
   â†’ AlÄ±m FiyatÄ±: $${displayPrice.toFixed(4)} (â‰¤ $${gridTradingBot.buyPrice})
   â†’ AlÄ±nan Miktar: ${gridTradingBot.amount} ${getAssetSymbol(autoTradeAssetIn)}
2ï¸âƒ£ SATIM AÅAMASI: ï¿½ BAÅLADI!
   â†’ Hedef: Fiyat â‰¥ $${gridTradingBot.sellPrice} (eÅŸit veya Ã¼stÃ¼nde)
   â†’ SatÄ±lacak: Bot'daki ${getAssetSymbol(autoTradeAssetOut)} tokenlar
3ï¸âƒ£ KAR TRANSFERÄ°: â³ SatÄ±m sonrasÄ± otomatik transfer

ğŸ“Š ÅU ANDA: 2ï¸âƒ£ SatÄ±m fiyatÄ± bekleniyor ($${gridTradingBot.sellPrice} ve Ã¼stÃ¼)
ğŸ”„ Otomatik dÃ¶ngÃ¼ devam ediyor...`
            };
            
            setGridTradingBot(updatedGridBot);
            localStorage.setItem(`grid_bot_${publicKey}`, JSON.stringify(updatedGridBot));
            
          } else if (gridTradingBot.currentStep === 'waiting_sell' && 
                     displayPrice >= parseFloat(gridTradingBot.sellPrice)) {
            
            setAutoTradeStatus(`ğŸ¤– Grid Bot: SatÄ±m tetiklendi! $${displayPrice.toFixed(4)} â‰¥ $${gridTradingBot.sellPrice} (eÅŸit veya Ã¼stÃ¼nde)`);
            
            // SatÄ±m iÅŸlemini gerÃ§ekleÅŸtir (Transfer VAR - kazanÃ§ ana cÃ¼zdana gidecek)
            try {
              if (botWallet) {
                const response = await fetch(`https://horizon-testnet.stellar.org/accounts/${botWallet.publicKey}`);
                if (response.ok) {
                  const account = await response.json();
                  
                  // Debug: Bot cÃ¼zdanÄ±ndaki tÃ¼m asset'leri logla
                  console.log('ğŸ¤– Grid Bot cÃ¼zdanÄ±ndaki asset\'ler:', account.balances);
                  account.balances.forEach((balance: any, index: number) => {
                    console.log(`Asset ${index}:`, {
                      type: balance.asset_type,
                      code: balance.asset_code,
                      issuer: balance.asset_issuer,
                      contract: balance.asset_contract,
                      asset: balance.asset,
                      balance: balance.balance
                    });
                  });
                  
                  // SatÄ±lacak asset'i bul (alÄ±m sonrasÄ± bot'da kalan token)
                  const targetAssetValue = autoTradeAssetOut;
                  const targetAssetInfo = ASSET_OPTIONS.find(a => a.value === targetAssetValue);
                  
                  console.log('ğŸ¯ Aranan asset:', {
                    value: targetAssetValue,
                    symbol: targetAssetInfo?.symbol,
                    label: targetAssetInfo?.label,
                    rawAssetOptions: ASSET_OPTIONS
                  });
                  
                  console.log('ğŸ” Asset matching baÅŸlÄ±yor...');
                  
                  const targetBalance = account.balances.find((balance: any, index: number) => {
                    console.log(`ğŸ” Checking asset ${index}:`, {
                      balanceType: balance.asset_type,
                      balanceCode: balance.asset_code,
                      balanceIssuer: balance.asset_issuer?.slice(0, 10) + '...',
                      balanceContract: balance.asset_contract?.slice(0, 10) + '...',
                      targetValue: targetAssetValue.slice(0, 20) + '...',
                      targetSymbol: targetAssetInfo?.symbol
                    });
                    
                    if (targetAssetValue.includes('native')) {
                      const isMatch = balance.asset_type === 'native';
                      console.log(`   â†’ Native match: ${isMatch}`);
                      return isMatch;
                    } else {
                      const targetSymbol = targetAssetInfo?.symbol;
                      
                      // Soroswap contract asset iÃ§in geliÅŸmiÅŸ matching
                      if (balance.asset_type === 'credit_alphanum4' || balance.asset_type === 'credit_alphanum12') {
                        // Geleneksel Stellar asset matching
                        const codeMatch = balance.asset_code && targetSymbol && (
                          balance.asset_code === targetSymbol ||
                          balance.asset_code.includes(targetSymbol) ||
                          targetSymbol.includes(balance.asset_code)
                        );
                        console.log(`   â†’ Credit asset code match: ${codeMatch} (${balance.asset_code} vs ${targetSymbol})`);
                        return codeMatch;
                      } else if (balance.asset_type === 'contract') {
                        // Soroswap contract asset matching
                        const contractMatch = balance.asset_contract === targetAssetValue ||
                               balance.asset === targetAssetValue;
                        const codeMatch = balance.asset_code && targetSymbol && (
                                 balance.asset_code === targetSymbol ||
                                 balance.asset_code.includes(targetSymbol) ||
                                 targetSymbol.includes(balance.asset_code)
                               );
                        const anyMatch = contractMatch || codeMatch;
                        console.log(`   â†’ Contract asset match: contractMatch=${contractMatch}, codeMatch=${codeMatch}, anyMatch=${anyMatch}`);
                        return anyMatch;
                      } else {
                        // Fallback - herhangi bir matching
                        const codeMatch = balance.asset_code && targetSymbol && (
                          balance.asset_code === targetSymbol ||
                          balance.asset_code.includes(targetSymbol) ||
                          targetSymbol.includes(balance.asset_code)
                        );
                        const contractMatch = balance.asset_contract === targetAssetValue ||
                                            balance.asset === targetAssetValue;
                        const anyMatch = codeMatch || contractMatch;
                        console.log(`   â†’ Fallback match: codeMatch=${codeMatch}, contractMatch=${contractMatch}, anyMatch=${anyMatch}`);
                        return anyMatch;
                      }
                    }
                  });
                  
                  console.log('ğŸ” Asset matching sonucu:', targetBalance);
                  
                  if (targetBalance && parseFloat(targetBalance.balance) > 0.1) {
                    // Bot'daki token miktarÄ±nÄ±n %95'ini sat (fee iÃ§in %5 rezerv)
                    const sellAmount = (parseFloat(targetBalance.balance) * 0.95).toFixed(4);
                    
                    // ğŸ”„ USDC BULMA ALGORÄ°TMASI - GeliÅŸtirilmiÅŸ
                    console.log('\nğŸ¯ USDC BULMA ALGORÄ°TMASI BAÅLADI');
                    console.log('Hedef Asset:', targetAssetInfo);
                    console.log('Bot CÃ¼zdan ID:', botWallet?.publicKey);
                    console.log('Bot Balances:', account.balances);
                    
                    // Birden fazla algoritma ile USDC ara
                    let usdcBalance = null;
                    
                    // Algoritma 1: Asset code ile arama
                    if (!usdcBalance) {
                      usdcBalance = account.balances.find((balance: any) => 
                        balance.asset_code === 'USDC'
                      );
                      if (usdcBalance) console.log('âœ… Algoritma 1: Asset code ile USDC bulundu:', usdcBalance);
                    }
                    
                    // Algoritma 2: Contract address ile arama
                    if (!usdcBalance) {
                      const usdcContractAddress = 'CBBHRKEP5M3NUDRISGLJKGHDHX3DA2CN2AZBQY6WLVUJ7VNLGSKBDUCM';
                      usdcBalance = account.balances.find((balance: any) => 
                        balance.asset_code === usdcContractAddress ||
                        balance.asset_issuer === usdcContractAddress ||
                        (balance.asset_type === 'contract' && balance.contract === usdcContractAddress)
                      );
                      if (usdcBalance) console.log('âœ… Algoritma 2: Contract address ile USDC bulundu:', usdcBalance);
                    }
                    
                    // Algoritma 3: Target asset ile eÅŸleÅŸtirme  
                    if (!usdcBalance && targetAssetInfo) {
                      usdcBalance = account.balances.find((balance: any) => {
                        if (targetAssetInfo.type === 'native') {
                          return balance.asset_type === 'native';
                        } else if (targetAssetInfo.type === 'contract') {
                          return balance.asset_type === 'contract' && 
                                 balance.contract === targetAssetInfo.contract;
                        } else if (targetAssetInfo.type === 'credit_alphanum4' || targetAssetInfo.type === 'credit_alphanum12') {
                          return balance.asset_code === targetAssetInfo.code && 
                                 balance.asset_issuer === targetAssetInfo.issuer;
                        }
                        return false;
                      });
                      if (usdcBalance) console.log('âœ… Algoritma 3: Target asset eÅŸleÅŸtirme ile bulundu:', usdcBalance);
                    }
                    
                    if (usdcBalance && parseFloat(usdcBalance.balance) > 0.1) {
                      const sellAmount = (parseFloat(usdcBalance.balance) * 0.95).toFixed(4);
                      console.log(`ğŸ’¸ Grid Bot: ${sellAmount} USDC satÄ±lacak`);
                      
                      setAutoTradeStatus(`ğŸ”„ Grid Bot: USDC satÄ±ÅŸÄ± yapÄ±lÄ±yor...`);
                      
                      // Grid Bot Ã¶zel satÄ±m fonksiyonuyla sat (transfer = true)
                      await executeGridBotTrade('sell', sellAmount, gridTradingBot.sellPrice, true);
                      
                      // Grid bot'u tamamlandÄ± olarak iÅŸaretle (USDC satÄ±m)
                      const completedGridBot = {
                        ...gridTradingBot,
                        currentStep: 'completed' as const,
                        sellHash: 'completed',
                        isActive: false,
                        status: `âœ… GRID BOT TAMAMLANDI! (USDC SatÄ±ÅŸ)
ğŸ”„ Ä°ÅLEM SIRASI TAMAMLANDI - NORMAL:
1ï¸âƒ£ ALIM: âœ… $${gridTradingBot.buyPrice} (â‰¤ eÅŸit veya altÄ±nda tetiklendi)
2ï¸âƒ£ SATIM: âœ… $${displayPrice.toFixed(4)} (â‰¥ eÅŸit veya Ã¼stÃ¼nde tetiklendi)  
3ï¸âƒ£ KAR TRANSFERÄ°: âœ… Ana cÃ¼zdana transfer edildi!

ğŸ’° Ä°ÅŸlem MiktarÄ±: ${gridTradingBot.amount} ${getAssetSymbol(autoTradeAssetIn)}
ğŸ’¸ SatÄ±lan USDC: ${sellAmount} USDC
âœ… Not: USDC baÅŸarÄ±yla bulundu ve satÄ±ldÄ±
ğŸ“ˆ GerÃ§ekleÅŸen Kar: ${((displayPrice - parseFloat(gridTradingBot.buyPrice)) / parseFloat(gridTradingBot.buyPrice) * 100).toFixed(2)}%
ğŸ‰ Grid trading dÃ¶ngÃ¼sÃ¼ baÅŸarÄ±yla tamamlandÄ±!`
                      };
                      
                      setGridTradingBot(completedGridBot);
                      localStorage.setItem(`grid_bot_${publicKey}`, JSON.stringify(completedGridBot));
                      
                      // 5 dakika sonra Grid Bot'u temizle
                      setTimeout(() => {
                        setGridTradingBot(null);
                        localStorage.removeItem(`grid_bot_${publicKey}`);
                      }, 5 * 60 * 1000);
                      
                    } else {
                      console.log('âŒ USDC bulunamadÄ±, XLM ile deneyim...');
                      
                      // XLM ile alternatif satÄ±ÅŸ (Debug modu)
                      const xlmBalance = account.balances.find((balance: any) => 
                        balance.asset_type === 'native' && parseFloat(balance.balance) > 2.5 // Min 2.5 XLM rezerv
                      );
                      
                      if (xlmBalance) {
                        const sellAmount = (parseFloat(xlmBalance.balance) * 0.7).toFixed(4); // %70'ini sat
                        
                        console.log(`ğŸ’¸ Grid Bot Alternatif: ${sellAmount} XLM satÄ±lacak (Debug mode)`);
                        
                        setAutoTradeStatus(`ğŸ”„ Grid Bot: USDC bulunamadÄ±, XLM satÄ±ÅŸÄ± yapÄ±lÄ±yor (Debug)...`);
                        
                        try {
                          // Grid Bot Ã¶zel satÄ±m fonksiyonuyla XLM sat (transfer = true)
                          await executeGridBotTrade('sell', sellAmount, gridTradingBot.sellPrice, true);
                          
                          // Grid bot'u tamamlandÄ± olarak iÅŸaretle (XLM debug satÄ±ÅŸ)
                          const completedGridBot = {
                            ...gridTradingBot,
                            currentStep: 'completed' as const,
                            sellHash: 'completed',
                            isActive: false,
                            status: `âš ï¸ GRID BOT TAMAMLANDI! (DEBUG MODE - XLM SatÄ±ÅŸ)
ğŸ”„ Ä°ÅLEM SIRASI TAMAMLANDI - DEBUG:
1ï¸âƒ£ ALIM: âš ï¸ $${gridTradingBot.buyPrice} (SatÄ±n alma baÅŸarÄ±lÄ± olmamÄ±ÅŸ olabilir)
2ï¸âƒ£ SATIM: âœ… $${displayPrice.toFixed(4)} (XLM ile satÄ±ÅŸ yapÄ±ldÄ±)  
3ï¸âƒ£ KAR TRANSFERÄ°: âœ… Ana cÃ¼zdana transfer edildi!

ğŸ’° Planlanan Ä°ÅŸlem: ${gridTradingBot.amount} ${getAssetSymbol(autoTradeAssetIn)}
ï¿½ GerÃ§ek SatÄ±ÅŸ: ${sellAmount} XLM (Debug Mode)
âš ï¸ UYARI: USDC bulunamadÄ±, alÄ±m iÅŸlemi baÅŸarÄ±sÄ±z olmuÅŸ olabilir
ğŸ“ˆ Fiyat FarkÄ±: ${((displayPrice - parseFloat(gridTradingBot.buyPrice)) / parseFloat(gridTradingBot.buyPrice) * 100).toFixed(2)}%
ğŸ”§ Debug modunda Grid trading tamamlandÄ± (sorun var)!`
                          };
                          
                          setGridTradingBot(completedGridBot);
                          localStorage.setItem(`grid_bot_${publicKey}`, JSON.stringify(completedGridBot));
                          
                          // 3 dakika sonra Grid Bot'u temizle (debug mode)
                          setTimeout(() => {
                            setGridTradingBot(null);
                            localStorage.removeItem(`grid_bot_${publicKey}`);
                          }, 3 * 60 * 1000);
                          
                        } catch (xlmSellError) {
                          console.error('XLM satÄ±ÅŸ hatasÄ±:', xlmSellError);
                          setAutoTradeStatus(`âŒ Grid Bot: XLM satÄ±ÅŸ hatasÄ±: ${xlmSellError}`);
                          
                          // Grid Bot'u hata olarak iÅŸaretle
                          const errorGridBot = {
                            ...gridTradingBot,
                            status: `âŒ Grid Bot HatasÄ±: XLM satÄ±ÅŸ baÅŸarÄ±sÄ±z - ${xlmSellError}`
                          };
                          setGridTradingBot(errorGridBot);
                          localStorage.setItem(`grid_bot_${publicKey}`, JSON.stringify(errorGridBot));
                        }
                        
                      } else {
                        console.log('âŒ Yeterli XLM bulunamadÄ± (min 2.5 XLM gerekiyor)');
                        setAutoTradeStatus('âŒ Grid Bot: SatÄ±labilir asset bulunamadÄ±');
                        
                        // Grid Bot'u hata olarak iÅŸaretle
                        const errorGridBot = {
                          ...gridTradingBot,
                          status: `âŒ Grid Bot HatasÄ±: Bot cÃ¼zdanÄ±nda satÄ±labilir asset bulunamadÄ±
                          
ğŸ” Bot CÃ¼zdan Durumu:
- Bot ID: ${botWallet?.publicKey}
- Mevcut Balances: ${JSON.stringify(account.balances, null, 2)}
- Aranan Asset: USDC (${targetAssetInfo?.contract})
- XLM Balance: ${account.balances.find((b: any) => b.asset_type === 'native')?.balance || '0'} XLM

âš ï¸ Muhtemel sebep: AlÄ±m iÅŸlemi baÅŸarÄ±sÄ±z oldu ve USDC alÄ±namadÄ±`
                        };
                        setGridTradingBot(errorGridBot);
                        localStorage.setItem(`grid_bot_${publicKey}`, JSON.stringify(errorGridBot));
                      }
                    }
                    
                  } else {
                    console.log('âš ï¸ Hedef asset bulunamadÄ±, USDC iÃ§eren asset aranÄ±yor...');
                    
                    // Ã–nce USDC iÃ§eren herhangi bir asset'i ara
                    const usdcAssets = account.balances.filter((balance: any) => {
                      const hasBalance = parseFloat(balance.balance) > 0.1;
                      
                      // USDC matching iÃ§in farklÄ± yÃ¶ntemler deneyelim
                      const codeMatch = balance.asset_code && (
                        balance.asset_code.includes('USDC') ||
                        balance.asset_code.includes('USD') ||
                        balance.asset_code === 'USDC'
                      );
                      
                      // Contract address matching
                      const contractMatch = balance.asset_contract === 'CBBHRKEP5M3NUDRISGLJKGHDHX3DA2CN2AZBQY6WLVUJ7VNLGSKBDUCM' ||
                                          balance.asset === 'CBBHRKEP5M3NUDRISGLJKGHDHX3DA2CN2AZBQY6WLVUJ7VNLGSKBDUCM';
                      
                      // Issuer matching (geleneksel Stellar asset iÃ§in)
                      const issuerMatch = balance.asset_issuer && balance.asset_code === 'USDC';
                      
                      const isUSDC = codeMatch || contractMatch || issuerMatch;
                      
                      console.log(`ğŸ” USDC check - Asset: ${balance.asset_code}, Type: ${balance.asset_type}, Contract: ${balance.asset_contract?.slice(0, 10)}..., hasBalance: ${hasBalance}, codeMatch: ${codeMatch}, contractMatch: ${contractMatch}, issuerMatch: ${issuerMatch}, isUSDC: ${isUSDC}`);
                      
                      return hasBalance && isUSDC;
                    });
                    
                    console.log('ğŸ” USDC iÃ§eren asset\'ler:', usdcAssets);
                    
                    if (usdcAssets.length > 0) {
                      // Ä°lk USDC asset'ini seÃ§
                      const usdcBalance = usdcAssets[0];
                      const sellAmount = (parseFloat(usdcBalance.balance) * 0.95).toFixed(4);
                      
                      console.log(`ğŸ’¸ Grid Bot USDC bulundu: ${sellAmount} ${usdcBalance.asset_code} satÄ±lacak`);
                      
                      setAutoTradeStatus(`ğŸ”„ Grid Bot: USDC asset bulundu, ${usdcBalance.asset_code} satÄ±lÄ±yor...`);
                      
                      // Grid Bot Ã¶zel satÄ±m fonksiyonuyla sat (transfer = true)
                      await executeGridBotTrade('sell', sellAmount, gridTradingBot.sellPrice, true);
                      
                      // Grid bot'u tamamlandÄ± olarak iÅŸaretle (USDC satÄ±m)
                      const completedGridBot = {
                        ...gridTradingBot,
                        currentStep: 'completed' as const,
                        sellHash: 'completed',
                        isActive: false,
                        status: `âœ… GRID BOT TAMAMLANDI! (USDC Bulundu)
ğŸ”„ Ä°ÅLEM SIRASI TAMAMLANDI:
1ï¸âƒ£ ALIM: âœ… $${gridTradingBot.buyPrice} (â‰¤ eÅŸit veya altÄ±nda tetiklendi)
2ï¸âƒ£ SATIM: âœ… $${displayPrice.toFixed(4)} (â‰¥ eÅŸit veya Ã¼stÃ¼nde tetiklendi)  
3ï¸âƒ£ KAR TRANSFERÄ°: âœ… Ana cÃ¼zdana transfer edildi!

ğŸ’° Ä°ÅŸlem MiktarÄ±: ${gridTradingBot.amount} ${getAssetSymbol(autoTradeAssetIn)}
ğŸ’¸ SatÄ±lan USDC: ${sellAmount} ${usdcBalance.asset_code}
âœ… Not: USDC asset baÅŸarÄ±yla bulundu ve satÄ±ldÄ±
ğŸ“ˆ GerÃ§ekleÅŸen Kar: ${((displayPrice - parseFloat(gridTradingBot.buyPrice)) / parseFloat(gridTradingBot.buyPrice) * 100).toFixed(2)}%
ğŸ‰ Grid trading dÃ¶ngÃ¼sÃ¼ baÅŸarÄ±yla tamamlandÄ±!`
                      };
                      
                      setGridTradingBot(completedGridBot);
                      localStorage.setItem(`grid_bot_${publicKey}`, JSON.stringify(completedGridBot));
                      
                      // 5 dakika sonra Grid Bot'u temizle
                      setTimeout(() => {
                        setGridTradingBot(null);
                        localStorage.removeItem(`grid_bot_${publicKey}`);
                      }, 5 * 60 * 1000);
                      
                    } else {
                      console.log('âš ï¸ USDC asset bulunamadÄ±, XLM satÄ±ÅŸÄ± deneniyor...');
                      
                      // XLM satÄ±ÅŸÄ±na izin ver (Grid Bot debug modu)
                      const xlmBalance = account.balances.find((balance: any) => 
                        balance.asset_type === 'native' && parseFloat(balance.balance) > 2.0 // Min 2 XLM rezerv
                      );
                      
                      if (xlmBalance) {
                        // XLM'nin %80'ini sat (rezerv bÄ±rak)
                        const sellAmount = (parseFloat(xlmBalance.balance) * 0.8).toFixed(4);
                        
                        console.log(`ğŸ’¸ Grid Bot XLM SatÄ±ÅŸ: ${sellAmount} XLM satÄ±lacak (Debug modu)`);
                        
                        setAutoTradeStatus(`ğŸ”„ Grid Bot: USDC bulunamadÄ±, XLM satÄ±ÅŸÄ± yapÄ±lÄ±yor (Debug)...`);
                        
                        // Grid Bot Ã¶zel satÄ±m fonksiyonuyla XLM sat (transfer = true)
                        try {
                          await executeGridBotTrade('sell', sellAmount, gridTradingBot.sellPrice, true);
                          
                          // Grid bot'u tamamlandÄ± olarak iÅŸaretle (XLM satÄ±m)
                          const completedGridBot = {
                            ...gridTradingBot,
                            currentStep: 'completed' as const,
                            sellHash: 'completed',
                            isActive: false,
                            status: `âœ… GRID BOT TAMAMLANDI! (XLM Debug SatÄ±ÅŸ)
ğŸ”„ Ä°ÅLEM SIRASI TAMAMLANDI:
1ï¸âƒ£ ALIM: âœ… $${gridTradingBot.buyPrice} (â‰¤ eÅŸit veya altÄ±nda tetiklendi)
2ï¸âƒ£ SATIM: âœ… $${displayPrice.toFixed(4)} (â‰¥ eÅŸit veya Ã¼stÃ¼nde tetiklendi)  
3ï¸âƒ£ KAR TRANSFERÄ°: âœ… Ana cÃ¼zdana transfer edildi!

ğŸ’° Ä°ÅŸlem MiktarÄ±: ${gridTradingBot.amount} ${getAssetSymbol(autoTradeAssetIn)}
ğŸ’¸ SatÄ±lan XLM: ${sellAmount} XLM (Debug Mode)
âš ï¸ Not: USDC bulunamadÄ±, XLM satÄ±ldÄ± (alÄ±m iÅŸlemi baÅŸarÄ±sÄ±z olmuÅŸ olabilir)
ğŸ“ˆ GerÃ§ekleÅŸen Ä°ÅŸlem: ${((displayPrice - parseFloat(gridTradingBot.buyPrice)) / parseFloat(gridTradingBot.buyPrice) * 100).toFixed(2)}%
ğŸ‰ Grid trading dÃ¶ngÃ¼sÃ¼ tamamlandÄ± (Debug)!`
                          };
                          
                          setGridTradingBot(completedGridBot);
                          localStorage.setItem(`grid_bot_${publicKey}`, JSON.stringify(completedGridBot));
                          
                          // 5 dakika sonra Grid Bot'u temizle
                          setTimeout(() => {
                            setGridTradingBot(null);
                            localStorage.removeItem(`grid_bot_${publicKey}`);
                          }, 5 * 60 * 1000);
                          
                        } catch (xlmSellError) {
                          console.error('XLM satÄ±ÅŸ hatasÄ±:', xlmSellError);
                          setAutoTradeStatus(`âŒ Grid Bot: XLM satÄ±ÅŸ hatasÄ±: ${xlmSellError}`);
                        }
                        
                      } else {
                        console.log('âš ï¸ XLM yetersiz (min 2 XLM gerekli), alternatif arama yapÄ±lÄ±yor...');
                        
                        // Alternatif: En yÃ¼ksek balance'lÄ± non-XLM asset'i sat
                        const nonXLMAssets = account.balances.filter((balance: any) => 
                          balance.asset_type !== 'native' && 
                          parseFloat(balance.balance) > 0.1
                        );
                        
                        console.log('ğŸ” Mevcut non-XLM asset\'ler:', nonXLMAssets);
                        
                        if (nonXLMAssets.length > 0) {
                          // En yÃ¼ksek balance'lÄ± asset'i seÃ§
                          const highestBalance = nonXLMAssets.reduce((prev: any, current: any) => 
                            parseFloat(current.balance) > parseFloat(prev.balance) ? current : prev
                          );
                          
                          const sellAmount = (parseFloat(highestBalance.balance) * 0.95).toFixed(4);
                          
                          console.log(`ğŸ’¸ Grid Bot Alternatif: ${sellAmount} ${highestBalance.asset_code} satÄ±lacak`);
                          
                          setAutoTradeStatus(`ğŸ”„ Grid Bot: Hedef asset bulunamadÄ±, ${highestBalance.asset_code} satÄ±lÄ±yor...`);
                          
                          try {
                            // Grid Bot Ã¶zel satÄ±m fonksiyonuyla sat (transfer = true)
                            await executeGridBotTrade('sell', sellAmount, gridTradingBot.sellPrice, true);
                            
                            // Grid bot'u tamamlandÄ± olarak iÅŸaretle (alternatif asset satÄ±m)
                            const completedGridBot = {
                              ...gridTradingBot,
                              currentStep: 'completed' as const,
                              sellHash: 'completed',
                              isActive: false,
                              status: `âœ… GRID BOT TAMAMLANDI! (Alternatif Asset SatÄ±ÅŸ)
ğŸ”„ Ä°ÅLEM SIRASI TAMAMLANDI:
1ï¸âƒ£ ALIM: âœ… $${gridTradingBot.buyPrice} (â‰¤ eÅŸit veya altÄ±nda tetiklendi)
2ï¸âƒ£ SATIM: âœ… $${displayPrice.toFixed(4)} (â‰¥ eÅŸit veya Ã¼stÃ¼nde tetiklendi)  
3ï¸âƒ£ KAR TRANSFERÄ°: âœ… Ana cÃ¼zdana transfer edildi!

ğŸ’° Ä°ÅŸlem MiktarÄ±: ${gridTradingBot.amount} ${getAssetSymbol(autoTradeAssetIn)}
ğŸ’¸ SatÄ±lan Asset: ${sellAmount} ${highestBalance.asset_code}
âš ï¸ Not: USDC bulunamadÄ±, alternatif asset satÄ±ldÄ±
ğŸ“ˆ GerÃ§ekleÅŸen Ä°ÅŸlem: ${((displayPrice - parseFloat(gridTradingBot.buyPrice)) / parseFloat(gridTradingBot.buyPrice) * 100).toFixed(2)}%
ğŸ‰ Grid trading dÃ¶ngÃ¼sÃ¼ tamamlandÄ± (Alternatif)!`
                            };
                            
                            setGridTradingBot(completedGridBot);
                            localStorage.setItem(`grid_bot_${publicKey}`, JSON.stringify(completedGridBot));
                            
                            // 5 dakika sonra Grid Bot'u temizle
                            setTimeout(() => {
                              setGridTradingBot(null);
                              localStorage.removeItem(`grid_bot_${publicKey}`);
                            }, 5 * 60 * 1000);
                            
                          } catch (altSellError) {
                            console.error('Alternatif asset satÄ±ÅŸ hatasÄ±:', altSellError);
                            setAutoTradeStatus(`âŒ Grid Bot: Alternatif asset satÄ±ÅŸ hatasÄ±: ${altSellError}`);
                          }
                          
                        } else {
                          console.log('âŒ SatÄ±labilir hiÃ§bir asset bulunamadÄ±');
                          setAutoTradeStatus('âŒ Grid Bot: SatÄ±labilir asset bulunamadÄ±');
                          
                          // Grid Bot'u hata olarak iÅŸaretle
                          const errorGridBot = {
                            ...gridTradingBot,
                            status: 'âŒ Grid Bot HatasÄ±: SatÄ±labilir asset bulunamadÄ±'
                          };
                          setGridTradingBot(errorGridBot);
                          localStorage.setItem(`grid_bot_${publicKey}`, JSON.stringify(errorGridBot));
                        }
                      }
                    }
                        
                        // Grid bot'u tamamlandÄ± olarak iÅŸaretle (alternatif satÄ±m)
                        const completedGridBot = {
                          ...gridTradingBot,
                          currentStep: 'completed' as const,
                          sellHash: 'completed',
                          isActive: false,
                          status: `âœ… GRID BOT TAMAMLANDI! (Alternatif SatÄ±m)
ğŸ”„ Ä°ÅLEM SIRASI TAMAMLANDI:
1ï¸âƒ£ ALIM: âœ… $${gridTradingBot.buyPrice} (â‰¤ eÅŸit veya altÄ±nda tetiklendi)
2ï¸âƒ£ SATIM: âœ… $${displayPrice.toFixed(4)} (â‰¥ eÅŸit veya Ã¼stÃ¼nde tetiklendi)  
3ï¸âƒ£ KAR TRANSFERÄ°: âœ… Ana cÃ¼zdana transfer edildi!

ğŸ’° Ä°ÅŸlem MiktarÄ±: ${gridTradingBot.amount} ${getAssetSymbol(autoTradeAssetIn)}
ğŸ’¸ SatÄ±lan Token: ${sellAmount} ${highestBalance.asset_code}
âš ï¸ Not: Hedef ${getAssetSymbol(autoTradeAssetOut)} bulunamadÄ±, ${highestBalance.asset_code} satÄ±ldÄ±
ğŸ“ˆ GerÃ§ekleÅŸen Kar: ${((displayPrice - parseFloat(gridTradingBot.buyPrice)) / parseFloat(gridTradingBot.buyPrice) * 100).toFixed(2)}%
ğŸ‰ Grid trading dÃ¶ngÃ¼sÃ¼ baÅŸarÄ±yla tamamlandÄ±!`
                        };
                        
                        setGridTradingBot(completedGridBot);
                        localStorage.setItem(`grid_bot_${publicKey}`, JSON.stringify(completedGridBot));
                        
                        // 5 dakika sonra Grid Bot'u temizle
                        setTimeout(() => {
                          setGridTradingBot(null);
                          localStorage.removeItem(`grid_bot_${publicKey}`);
                        }, 5 * 60 * 1000);
                        
                      } else {
                        // USDC bulunamadÄ±, XLM satÄ±ÅŸÄ± yapÄ±lacak (Debug Mode)
                        console.log('âŒ USDC bulunamadÄ±, XLM satÄ±ÅŸÄ± yapÄ±lÄ±yor...');
                        
                        const xlmBalance = account.balances.find((balance: any) => 
                          balance.asset_type === 'native' && parseFloat(balance.balance) > 2.0
                        );
                        
                        if (xlmBalance) {
                          const sellAmount = (parseFloat(xlmBalance.balance) * 0.7).toFixed(4);
                          console.log(`ğŸ’¸ Grid Bot Debug: ${sellAmount} XLM satÄ±lacak`);
                          
                          await executeGridBotTrade('sell', sellAmount, gridTradingBot.sellPrice, true);
                          
                          // Grid bot'u tamamlandÄ± olarak iÅŸaretle
                          const completedGridBot = {
                            ...gridTradingBot,
                            currentStep: 'completed' as const,
                            sellHash: 'completed',
                            isActive: false,
                            status: `âš ï¸ GRID BOT TAMAMLANDI! (DEBUG - XLM SatÄ±ÅŸ)
ï¿½ Ä°ÅLEM SIRASI TAMAMLANDI:
1ï¸âƒ£ ALIM: âš ï¸ $${gridTradingBot.buyPrice} (USDC alÄ±mÄ± baÅŸarÄ±sÄ±z olmuÅŸ olabilir)
2ï¸âƒ£ SATIM: âœ… $${displayPrice.toFixed(4)} (XLM ile debug satÄ±ÅŸ)
3ï¸âƒ£ KAR TRANSFERÄ°: âœ… Ana cÃ¼zdana transfer edildi!

ğŸ’° Planlanan: ${gridTradingBot.amount} ${getAssetSymbol(autoTradeAssetIn)}
ğŸ’¸ GerÃ§ek SatÄ±ÅŸ: ${sellAmount} XLM (Debug Mode)
âš ï¸ UYARI: USDC bulunamadÄ±, muhtemelen alÄ±m baÅŸarÄ±sÄ±z oldu
ğŸ”§ Debug modunda Grid trading tamamlandÄ±!`
                          };
                          
                          setGridTradingBot(completedGridBot);
                          localStorage.setItem(`grid_bot_${publicKey}`, JSON.stringify(completedGridBot));
                          
                          setTimeout(() => {
                            setGridTradingBot(null);
                            localStorage.removeItem(`grid_bot_${publicKey}`);
                          }, 3 * 60 * 1000);
                          
                        } else {
                          console.log('âŒ XLM yetersiz');
                          setAutoTradeStatus('âŒ Grid Bot: SatÄ±labilir asset bulunamadÄ±');
                          
                          const errorGridBot = {
                            ...gridTradingBot,
                            isActive: false,
                            status: `âŒ GRID BOT HATASI!
ğŸ” SatÄ±lacak asset bulunamadÄ±
ğŸ¤– Bot cÃ¼zdanÄ±nda yeterli token yok
ğŸ“Š Debug: Bot Balances = ${JSON.stringify(account.balances.map((b: any) => ({type: b.asset_type, code: b.asset_code, balance: b.balance})))}`
                          };
                          
                          setGridTradingBot(errorGridBot);
                          localStorage.setItem(`grid_bot_${publicKey}`, JSON.stringify(errorGridBot));
                        }
                      }
                    }
                  }
                    
                }
              }
            } catch (error) {
              console.error('Grid bot satÄ±m hatasÄ±:', error);
              setAutoTradeStatus(`âŒ Grid Bot satÄ±m hatasÄ±: ${error}`);
            }
          }
        }
        
        // GeÃ§erlilik sÃ¼resi kontrolÃ¼
        if (preAuthBuyOrder && now > preAuthBuyOrder.expiry) {
          setPreAuthBuyOrder(null);
          localStorage.removeItem(`preauth_buy_${publicKey}`);
          setAutoTradeStatus('â° Pre-auth alÄ±m emri sÃ¼resi doldu. Yeniden onaylayÄ±n.');
        }
        
        if (preAuthSellOrder && now > preAuthSellOrder.expiry) {
          setPreAuthSellOrder(null);
          localStorage.removeItem(`preauth_sell_${publicKey}`);
          setAutoTradeStatus('â° Pre-auth satÄ±m emri sÃ¼resi doldu. Yeniden onaylayÄ±n.');
        }
        
        if (gridTradingBot && now > gridTradingBot.expiry) {
          setGridTradingBot(null);
          localStorage.removeItem(`grid_bot_${publicKey}`);
          setAutoTradeStatus('â° Grid trading bot sÃ¼resi doldu. Yeniden oluÅŸturun.');
        }
        
      } catch (error: unknown) {
        console.error('âŒ Pre-auth iÅŸlem kontrolÃ¼ hatasÄ±:', error);
        const errorMessage = error instanceof Error ? error.message : 'Bilinmeyen hata';
        setAutoTradeStatus(`âŒ Kontrol hatasÄ±: ${errorMessage}`);
      }
    };

    checkPreAuthTrade();
  }, [displayPrice, isAutoTradingEnabled, isConnected, isTrading, preAuthBuyOrder, preAuthSellOrder, gridTradingBot, hasAutoTradeError, executeBotTrade, executeGridBotTrade, publicKey, botWallet, autoTradeAssetIn, autoTradeAssetOut, getAssetSymbol]);



  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900">
      {/* Header */}
      <div className="bg-white/10 backdrop-blur-md border-b border-white/20 sticky top-0 z-50">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex items-center justify-between h-16">
            <div className="flex items-center space-x-3">
              <div className="w-10 h-10 bg-gradient-to-br from-blue-500 via-purple-500 to-pink-500 rounded-xl flex items-center justify-center shadow-lg">
                <span className="text-white font-bold text-lg">ğŸ¤–</span>
              </div>
              <h1 className="text-2xl font-bold bg-gradient-to-r from-white via-blue-100 to-purple-100 bg-clip-text text-transparent">
                Pre-Auth Bot Trader
              </h1>
            </div>
            
            {/* Wallet Connection Status */}
            <div className="flex items-center space-x-4">
              {isConnected && publicKey ? (
                <div className="flex items-center space-x-3 bg-emerald-500/20 text-emerald-100 px-4 py-2 rounded-full text-sm backdrop-blur-sm border border-emerald-400/30">
                  <div className="w-3 h-3 bg-emerald-400 rounded-full animate-pulse"></div>
                  <div className="flex flex-col">
                    <span className="font-medium text-xs text-emerald-300">BaÄŸlandÄ±</span>
                    <span className="font-mono text-xs">
                      {publicKey.slice(0, 8)}...{publicKey.slice(-6)}
                    </span>
                  </div>
                </div>
              ) : (
                <button
                  onClick={connectWallet}
                  disabled={!isAvailable}
                  className="bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 hover:from-blue-600 hover:via-purple-600 hover:to-pink-600 disabled:from-gray-500 disabled:to-gray-600 text-white px-6 py-2.5 rounded-full font-medium transition-all duration-300 shadow-lg hover:shadow-xl hover:scale-105 backdrop-blur-sm"
                >
                  {isAvailable ? 'Connect Freighter' : 'Install Freighter'}
                </button>
              )}
            </div>
          </div>
        </div>
      </div>

      {/* Main Content */}
      <div className="max-w-4xl mx-auto px-4 py-8 space-y-6 relative z-10">
        {!isConnected ? (
          /* Wallet Connection Screen */
          <div className="text-center py-20">
            <div className="w-32 h-32 bg-gradient-to-br from-blue-500 via-purple-500 to-pink-500 rounded-3xl mx-auto mb-8 flex items-center justify-center shadow-2xl animate-pulse">
              <span className="text-6xl">ğŸ¤–</span>
            </div>
            <h2 className="text-4xl font-bold mb-6 bg-gradient-to-r from-white via-blue-100 to-purple-100 bg-clip-text text-transparent">
              Connect Your Wallet
            </h2>
            <p className="text-gray-300 mb-10 text-xl max-w-md mx-auto leading-relaxed">
              Connect your Freighter wallet to start automated price-based trading
            </p>
            <button
              onClick={connectWallet}
              disabled={!isAvailable}
              className="bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 hover:from-blue-600 hover:via-purple-600 hover:to-pink-600 disabled:from-gray-500 disabled:to-gray-600 text-white px-10 py-5 rounded-2xl font-semibold text-xl transition-all duration-300 shadow-2xl hover:shadow-3xl hover:scale-105 transform"
            >
              {isAvailable ? 'ğŸš€ Connect Freighter Wallet' : 'â¬‡ï¸ Install Freighter'}
            </button>
            {!isAvailable && (
              <div className="mt-6 text-gray-400">
                <p>Install Freighter browser extension first</p>
                <a href="https://freighter.app/" target="_blank" rel="noopener noreferrer" className="text-blue-400 hover:text-blue-300 underline">
                  Download Freighter
                </a>
              </div>
            )}
          </div>
        ) : (
          /* Trading Interface */
          <>
        <div className="text-center mb-8">
          <h2 className="text-4xl font-bold bg-gradient-to-r from-white via-blue-100 to-purple-100 bg-clip-text text-transparent mb-2">
            Fiyat BazlÄ± Otomatik Ä°ÅŸlem
          </h2>
          <p className="text-gray-300">
            Basit Pre-Authorization Sistemi
          </p>
        </div>

        {/* ğŸ¤– Bot GÃ¼venlik Modeli */}
        <Card className="bg-green-50 border-green-200">
          <div className="text-sm">
            <h3 className="font-bold text-green-800 mb-3">ğŸ¤– Bot Wallet Sistemi</h3>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <h4 className="font-semibold mb-2">ğŸ‘¤ Manuel Mod:</h4>
                <ul className="space-y-1 text-green-700">
                  <li>â€¢ Ana cÃ¼zdanÄ±nÄ±zdan para Ã§Ä±kar</li>
                  <li>â€¢ Her iÅŸlemde imza gerekir</li>
                  <li>â€¢ PC baÅŸÄ±nda olmanÄ±z gerekir</li>
                  <li>â€¢ Freighter popup aÃ§Ä±lÄ±r</li>
                </ul>
              </div>
              <div>
                <h4 className="font-semibold mb-2">ğŸ¤– Otomatik Mod:</h4>
                <ul className="space-y-1 text-green-700">
                  <li>â€¢ Bot cÃ¼zdanÄ±ndan para Ã§Ä±kar</li>
                  <li>â€¢ Bot otomatik imza atar</li>
                  <li>â€¢ PC kapalÄ± olabilir</li>
                  <li>â€¢ Tamamen otonom Ã§alÄ±ÅŸÄ±r</li>
                  <li>â€¢ Bot cÃ¼zdanÄ±na XLM transfer gerekli</li>
                  <li>â€¢ <strong>ğŸ’¸ KazanÃ§ Ã¶zel adrese transfer!</strong></li>
                </ul>
              </div>
            </div>
          </div>
        </Card>

        {/* ğŸ”— Wallet BaÄŸlantÄ± Durumu */}
        <Card className={`${isConnected ? 'bg-blue-50 border-blue-200' : 'bg-yellow-50 border-yellow-200'}`}>
          <div className="flex items-center justify-between">
            <div className="flex items-center space-x-3">
              <div className={`w-3 h-3 rounded-full ${isConnected ? 'bg-green-500' : 'bg-yellow-500'}`}></div>
              <div>
                <h3 className="font-semibold text-gray-800">
                  {isConnected ? 'âœ… Freighter BaÄŸlandÄ±' : 'ğŸ”— Freighter BaÄŸlantÄ±sÄ±'}
                </h3>
                {isConnected && publicKey ? (
                  <p className="text-sm text-gray-600">
                    {publicKey.substring(0, 4)}...{publicKey.substring(publicKey.length - 4)}
                  </p>
                ) : (
                  <p className="text-sm text-gray-600">CÃ¼zdan baÄŸlantÄ±sÄ± gerekli</p>
                )}
              </div>
            </div>
            {!isConnected && (
              <button
                onClick={async () => {
                  try {
                    await connect();
                  } catch (error) {
                    console.error('BaÄŸlantÄ± hatasÄ±:', error);
                  }
                }}
                disabled={!isAvailable}
                className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
              >
                {isAvailable ? 'CÃ¼zdan BaÄŸla' : 'Freighter YÃ¼kle'}
              </button>
            )}
            {isConnected && (
              <div className="text-sm text-green-600 font-medium">
                Manuel ve Bot modlarÄ± kullanÄ±labilir
              </div>
            )}
          </div>
          {freighterError && (
            <div className="mt-3 p-2 bg-red-100 border border-red-200 rounded">
              <p className="text-sm text-red-700">âŒ {freighterError}</p>
            </div>
          )}
        </Card>

        {/* Hata/Durum GÃ¶stergeleri */}
        {error && (
          <Card className="bg-red-50 border border-red-200">
            <div className="text-red-700"><strong>Hata:</strong> {error}</div>
          </Card>
        )}

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Sol Panel - Fiyat ve Durum */}
          <div className="space-y-4">
            <PriceDisplay
              price={displayPrice}
              lastUpdate={lastUpdate}
              isTracking={isTracking && !manualPriceMode}
            />

            {/* Manuel Fiyat KontrolÃ¼ */}
            <Card title="ğŸ“Š Fiyat KontrolÃ¼">
              <div className="space-y-3">
                <div className="flex items-center space-x-2">
                  <input
                    type="checkbox"
                    id="manualPriceMode"
                    checked={manualPriceMode}
                    onChange={(e) => setManualPriceMode(e.target.checked)}
                    className="rounded border-gray-300"
                  />
                  <label htmlFor="manualPriceMode" className="text-sm font-medium">
                    Manuel Fiyat Modu
                  </label>
                </div>
                
                {manualPriceMode ? (
                  <div className="space-y-2">
                    <input
                      type="number"
                      step="0.0001"
                      placeholder="XLM fiyatÄ± girin ($)"
                      value={manualPrice}
                      onChange={(e) => setManualPrice(e.target.value)}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                    <div className="text-xs text-gray-500">
                      Manuel mod: GerÃ§ek fiyat takibi durdu
                    </div>
                  </div>
                ) : (
                  <div className="text-xs text-gray-500">
                    Otomatik mod: GerÃ§ek zamanlÄ± fiyat takibi
                  </div>
                )}
              </div>
            </Card>

            {/* Takip Kontrolleri */}
            <Card title="ğŸ“Š Fiyat Takibi">
              <div className="space-y-3">
                {!isTracking ? (
                  <Button 
                    onClick={() => startTracking(15000)} 
                    variant="success" 
                    className="w-full"
                    disabled={manualPriceMode}
                  >
                    â–¶ï¸ Takibi BaÅŸlat (5s)
                  </Button>
                ) : (
                  <Button onClick={stopTracking} variant="error" className="w-full">
                    â¹ï¸ Takibi Durdur
                  </Button>
                )}
              </div>
            </Card>

            {/* Freighter Wallet */}
            <Card title="ğŸŒŒ Freighter Wallet" className="bg-purple-50 border-purple-200">
              <div className="space-y-3">
                <div className="text-xs bg-white p-3 rounded border">
                  <div className="flex items-center gap-2 mb-2">
                    <span className={`w-3 h-3 rounded-full ${isAvailable ? 'bg-green-500' : 'bg-red-500'}`}></span>
                    <span className="font-medium">Freighter: {isAvailable ? 'âœ… YÃ¼klÃ¼' : 'âŒ YÃ¼klÃ¼ deÄŸil'}</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <span className={`w-3 h-3 rounded-full ${isConnected ? 'bg-green-500' : 'bg-red-500'}`}></span>
                    <span className="font-medium">BaÄŸlantÄ±: {isConnected ? 'âœ… BaÄŸlÄ±' : 'âŒ BaÄŸlÄ± deÄŸil'}</span>
                  </div>
                  {publicKey && (
                    <div className="text-xs text-gray-600 mt-2 p-2 bg-gray-50 rounded">
                      <div className="font-mono break-all">
                        {publicKey.slice(0, 10)}...{publicKey.slice(-10)}
                      </div>
                    </div>
                  )}
                  {freighterError && (
                    <div className="mt-2 p-2 bg-red-50 rounded border-l-4 border-red-400">
                      <div className="text-xs text-red-700">
                        <strong>Hata:</strong> {freighterError}
                      </div>
                    </div>
                  )}
                </div>

                {!isConnected && (
                  <div className="space-y-2">
                    <Button onClick={connectWallet} disabled={!isAvailable} className="w-full" variant="success">
                      ğŸ”— Freighter&apos;a BaÄŸlan
                    </Button>
                    <div className="text-xs bg-yellow-100 p-2 rounded text-yellow-700">
                      âš ï¸ <strong>localhost baÄŸlantÄ± sorunu:</strong> EÄŸer &quot;domain not connected&quot; hatasÄ± alÄ±yorsanÄ±z, bu butona basarak yeniden baÄŸlanÄ±n.
                    </div>
                  </div>
                )}
              </div>
            </Card>

            {/* Bot Wallet Sistemi */}
            <Card title="ğŸ¤– Bot Wallet (Tam Otomatik)" className="bg-blue-50 border-blue-200">
              <div className="space-y-3">
                <div className="flex items-center gap-2 mb-3">
                  <label className="text-sm font-medium">Bot Modu:</label>
                  <select 
                    value={botMode} 
                    onChange={(e) => setBotMode(e.target.value as 'manual' | 'auto')}
                    className="px-2 py-1 border rounded text-sm"
                    disabled={!isConnected}
                  >
                    <option value="manual">ğŸ‘¤ Manuel (KullanÄ±cÄ± Ä°mza)</option>
                    <option value="auto">ğŸ¤– Otomatik (Bot Ä°mza)</option>
                  </select>
                </div>

                {botMode === 'auto' && (
                  <div className="space-y-3">
                    {!botWallet ? (
                      <div className="space-y-2">
                        <div className="text-sm bg-yellow-100 p-2 rounded text-yellow-800">
                          âš ï¸ Bot wallet oluÅŸturun ve XLM transfer edin
                        </div>
                        <Button 
                          onClick={createBotWallet} 
                          disabled={!isConnected} 
                          className="w-full" 
                          variant="success"
                        >
                          ğŸ¤– Bot Wallet OluÅŸtur
                        </Button>
                      </div>
                    ) : (
                      <div className="space-y-2">
                        <div className="text-xs bg-blue-100 p-2 rounded border">
                          <div className="font-medium text-blue-800">ğŸ¤– Bot Wallet Aktif</div>
                          <div className="font-mono text-xs mt-1 break-all">
                            <strong>Public Key:</strong><br/>
                            {botWallet.publicKey}
                          </div>
                          <div className="font-mono text-xs mt-2 break-all">
                            <strong>Secret Key:</strong><br/>
                            <span className="text-red-600 bg-red-50 p-1 rounded">
                              {botWallet.secretKey}
                            </span>
                          </div>
                          <div className="mt-2">
                            <span className="font-medium">Balance: </span>
                            <span className={`font-mono ${botBalance > 0 ? 'text-green-600' : 'text-red-600'}`}>
                              {botBalance.toFixed(2)} XLM
                            </span>
                          </div>
                        </div>
                        
                        {botBalance === 0 && (
                          <div className="text-xs bg-red-100 p-2 rounded text-red-700">
                            âŒ Bot wallet&apos;a minimum 2 XLM transfer edin!
                          </div>
                        )}
                        
                        {botBalance > 0 && botBalance < 2 && (
                          <div className="text-xs bg-yellow-100 p-2 rounded text-yellow-700">
                            âš ï¸ DÃ¼ÅŸÃ¼k bakiye! Minimum 2 XLM Ã¶nerilir (Mevcut: {botBalance.toFixed(2)} XLM)
                          </div>
                        )}
                        
                        {botBalance >= 2 && (
                          <div className="text-xs bg-green-100 p-2 rounded text-green-700">
                            âœ… Bot wallet hazÄ±r! Ä°ÅŸlem yapabilir.
                          </div>
                        )}
                        
                        <div className="text-xs bg-yellow-100 p-2 rounded text-yellow-800">
                          âš ï¸ <strong>GÃœVENLÄ°K:</strong> Secret key&apos;i kimseyle paylaÅŸmayÄ±n!
                        </div>
                        
                        <div className="flex gap-2">
                          <Button 
                            onClick={() => checkBotBalance(botWallet.publicKey)} 
                            size="sm" 
                            className="flex-1"
                          >
                            ğŸ”„ Balance
                          </Button>
                          <Button 
                            onClick={async () => {
                              try {
                                setAutoTradeStatus('ğŸ§ª Test transfer baÅŸlatÄ±lÄ±yor...');
                                // Test transfer - bot'daki tÃ¼m XLM'i transfer et
                                await transferProfitToMainWallet(
                                  'native',
                                  botWallet,
                                  customWalletAddress
                                );
                                setAutoTradeStatus('âœ… Test transfer tamamlandÄ±!');
                              } catch (error) {
                                setAutoTradeStatus(`âŒ Test transfer hatasÄ±: ${error}`);
                              }
                            }} 
                            size="sm" 
                            variant="success"
                            className="flex-1"
                          >
                            ğŸ§ª Test Transfer
                          </Button>
                        </div>
                        
                        <div className="flex gap-2">
                          <Button 
                            onClick={() => {
                              navigator.clipboard.writeText(botWallet.publicKey);
                              alert('Public Key kopyalandÄ±!');
                            }} 
                            size="sm" 
                            className="flex-1"
                          >
                            ï¿½ Public
                          </Button>
                          <Button 
                            onClick={() => {
                              navigator.clipboard.writeText(botWallet.secretKey);
                              alert('Secret Key kopyalandÄ±!');
                            }} 
                            size="sm" 
                            variant="error"
                            className="flex-1"
                          >
                            ï¿½ Secret Key
                          </Button>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {botMode === 'manual' && (
                  <div className="text-xs bg-gray-100 p-2 rounded text-gray-600">
                    ğŸ‘¤ Manuel modda kullanÄ±cÄ± her iÅŸlem iÃ§in imza atar
                  </div>
                )}
              </div>
            </Card>

            {/* Telegram Kurulum */}
            <Card title="ğŸ“± Telegram">
              <div className="space-y-3">
                <input
                  type="text"
                  value={telegramChatId}
                  onChange={(e) => {
                    setTelegramChatId(e.target.value);
                    localStorage.setItem('telegram_chat_id', e.target.value);
                  }}
                  className="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                  placeholder="Chat ID (@userinfobot)"
                />
                <div className="text-xs text-gray-500">
                  @userinfobot&apos;tan Chat ID alÄ±n
                </div>
              </div>
            </Card>

            {/* Custom Wallet Address */}
            <Card title="ğŸ’° KazanÃ§ CÃ¼zdanÄ±" className="bg-orange-50 border-orange-200">
              <div className="space-y-3">
                <div>
                  <label className="block text-sm font-medium mb-1 text-orange-800">
                    KazanÃ§ GÃ¶nderilecek CÃ¼zdan Adresi:
                  </label>
                  <input
                    type="text"
                    value={customWalletAddress}
                    onChange={(e) => {
                      setCustomWalletAddress(e.target.value);
                      localStorage.setItem('custom_wallet_address', e.target.value);
                    }}
                    className="w-full px-3 py-2 border border-orange-300 rounded text-sm font-mono"
                    placeholder="GXXX...XXXX (Stellar Address)"
                  />
                </div>
                <div className="text-xs text-orange-700 bg-orange-100 p-2 rounded">
                  <div className="font-semibold mb-1">ğŸ’¸ Ã–nemli Bilgi:</div>
                  <div>Bot otomatik modda tÃ¼m kazancÄ± bu adrese gÃ¶nderir.</div>
                  <div>Bu adres Freighter wallet adresinizden farklÄ± olabilir.</div>
                </div>
                {customWalletAddress && (
                  <div className="text-xs text-gray-600 bg-gray-50 p-2 rounded">
                    <div className="font-semibold">Mevcut KazanÃ§ Adresi:</div>
                    <div className="font-mono break-all mt-1">
                      {customWalletAddress}
                    </div>
                  </div>
                )}
              </div>
            </Card>
          </div>

          {/* SaÄŸ Panel - ğŸ¯ Fiyat BazlÄ± Otomatik Ä°ÅŸlem (Ana Odak) */}
          <div className="lg:col-span-2">
            <Card title="ğŸ¯ Fiyat BazlÄ± Otomatik Ä°ÅŸlem" className="bg-gradient-to-r from-green-50 to-blue-50 border-2 border-green-300">
              {isConnected ? (
                <div className="space-y-6">
                  {/* Otomatik Ä°ÅŸlem Toggle */}
                  <div className="flex items-center justify-between p-4 bg-white rounded-lg border-2 border-gray-200">
                    <div>
                      <h3 className="font-bold text-lg">ğŸ¤– Otomatik Ä°ÅŸlem Sistemi</h3>
                      <p className="text-sm text-gray-600">BelirlediÄŸiniz fiyatlarda otomatik alÄ±m-satÄ±m (Pre-Authorization)</p>
                    </div>
                    <div className="flex items-center gap-3">
                      {hasAutoTradeError && (
                        <Button
                          onClick={() => {
                            setHasAutoTradeError(false);
                            setAutoTradeStatus('âœ… Sistem sÄ±fÄ±rlandÄ±, hazÄ±r.');
                            setIsAutoTradingEnabled(true);
                            setBuyTargetPrice('');
                            setSellTargetPrice('');
                            setAutoBuyAmount('');
                            setAutoSellAmount('');
                          }}
                          size="sm"
                          variant="success"
                        >
                          ğŸ”„ Reset
                        </Button>
                      )}
                      <label className="flex items-center gap-2">
                        <input
                          type="checkbox"
                          checked={isAutoTradingEnabled}
                          onChange={(e) => {
                            setIsAutoTradingEnabled(e.target.checked);
                            if (e.target.checked && hasAutoTradeError) {
                              setHasAutoTradeError(false);
                              setAutoTradeStatus(null);
                            }
                          }}
                          className="rounded"
                          disabled={isTrading}
                        />
                        <span className={`font-medium ${isAutoTradingEnabled ? 'text-green-600' : 'text-gray-500'}`}>
                          {isAutoTradingEnabled ? 'ğŸŸ¢ AKTÄ°F' : 'âšª PASÄ°F'}
                        </span>
                      </label>
                    </div>
                  </div>

                  {/* Trading Pair SeÃ§imi */}
                  <div className="p-4 bg-gray-50 rounded-lg border">
                    <h4 className="font-semibold mb-3">ğŸ”„ Trading Pair</h4>
                    <div className="grid grid-cols-3 gap-2 items-center">
                      <select
                        value={autoTradeAssetIn}
                        onChange={(e) => setAutoTradeAssetIn(e.target.value)}
                        className="px-3 py-2 border border-gray-300 rounded"
                        disabled={isTrading}
                      >
                        {ASSET_OPTIONS.map((asset) => (
                          <option key={asset.value} value={asset.value}>
                            {asset.symbol}
                          </option>
                        ))}
                      </select>
                      <div className="text-center">
                        <button
                          onClick={() => {
                            const temp = autoTradeAssetIn;
                            setAutoTradeAssetIn(autoTradeAssetOut);
                            setAutoTradeAssetOut(temp);
                          }}
                          className="bg-blue-100 hover:bg-blue-200 p-2 rounded-full"
                          disabled={isTrading}
                        >
                          â†”ï¸
                        </button>
                      </div>
                      <select
                        value={autoTradeAssetOut}
                        onChange={(e) => setAutoTradeAssetOut(e.target.value)}
                        className="px-3 py-2 border border-gray-300 rounded"
                        disabled={isTrading}
                      >
                        {ASSET_OPTIONS.map((asset) => (
                          <option key={asset.value} value={asset.value}>
                            {asset.symbol}
                          </option>
                        ))}
                      </select>
                    </div>
                    <div className="text-center mt-2 text-sm text-gray-600">
                      {ASSET_OPTIONS.find(a => a.value === autoTradeAssetIn)?.symbol}/{ASSET_OPTIONS.find(a => a.value === autoTradeAssetOut)?.symbol}
                    </div>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {/* AlÄ±m AyarlarÄ± */}
                    <div className="p-4 bg-green-50 rounded-lg border-2 border-green-200">
                      <h4 className="font-semibold text-green-800 mb-3">ğŸ’° Otomatik AlÄ±m</h4>
                      <div className="space-y-3">
                        <div>
                          <label className="block text-sm font-medium mb-1">Hedef Fiyat ($)</label>
                          <input
                            type="number"
                            step="0.0001"
                            placeholder="0.1200"
                            value={buyTargetPrice}
                            onChange={(e) => setBuyTargetPrice(e.target.value)}
                            className="w-full px-3 py-2 border border-green-300 rounded"
                            disabled={isTrading || !isAutoTradingEnabled}
                          />
                          <p className="text-xs text-green-600 mt-1">
                            Fiyat â‰¤ Bu deÄŸerde al
                          </p>
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">
                            Miktar ({ASSET_OPTIONS.find(a => a.value === autoTradeAssetIn)?.symbol})
                          </label>
                          <input
                            type="number"
                            min="1"
                            step="1"
                            placeholder="10"
                            value={autoBuyAmount}
                            onChange={(e) => setAutoBuyAmount(e.target.value)}
                            className="w-full px-3 py-2 border border-green-300 rounded"
                            disabled={isTrading || !isAutoTradingEnabled}
                          />
                        </div>
                        {buyTargetPrice && (
                          <div className={`text-sm p-2 rounded ${displayPrice <= parseFloat(buyTargetPrice) ? 'bg-green-200 text-green-800 font-bold' : 'bg-gray-100 text-gray-600'}`}>
                            {displayPrice <= parseFloat(buyTargetPrice) ? 'ğŸ¯ HEDEF ULAÅILDI!' : 'â³ Hedef bekleniyor...'}
                          </div>
                        )}
                        
                        {/* Pre-Authorization Button */}
                        <div className="space-y-2">
                          {!preAuthBuyOrder ? (
                            <div className="space-y-2">
                              {/* Manuel Mod Butonu */}
                              <Button
                                onClick={() => createPreAuthBuyOrder(false)}
                                disabled={!buyTargetPrice || !autoBuyAmount || !isConnected}
                                size="sm"
                                variant="secondary"
                                className="w-full"
                              >
                                ğŸ‘¤ Manuel AlÄ±m Emri
                              </Button>
                              
                              {/* Bot Mod Butonu */}
                              {botMode === 'auto' && botWallet ? (
                                <div className="space-y-2">
                                  <Button
                                    onClick={() => createPreAuthBuyOrder(true)}
                                    disabled={!buyTargetPrice || !autoBuyAmount || !isConnected}
                                    size="sm"
                                    variant="success"
                                    className="w-full"
                                  >
                                    ğŸ¤– Bot AlÄ±m Emri (XLM Transfer)
                                  </Button>
                                  {!isConnected && (
                                    <div className="text-xs bg-red-100 p-2 rounded text-red-700 border">
                                      âš ï¸ Freighter baÄŸlantÄ±sÄ± gerekli! Butona basÄ±nca otomatik baÄŸlanÄ±r.
                                    </div>
                                  )}
                                </div>
                              ) : (
                                <div className="text-xs bg-yellow-100 p-2 rounded text-yellow-700 border">
                                  âš ï¸ Bot modu iÃ§in &quot;ğŸ¤– Otomatik&quot; modunu seÃ§in ve bot wallet oluÅŸturun.
                                </div>
                              )}
                            </div>
                          ) : (
                            <div className="space-y-2">
                              <div className="text-xs bg-green-100 text-green-700 p-2 rounded border">
                                âœ… AlÄ±m emri hazÄ±r
                                <div className="text-xs mt-1">
                                  â° SÃ¼re: {Math.round((preAuthBuyOrder.expiry.getTime() - Date.now()) / 60000)} dk kaldÄ±
                                </div>
                              </div>
                              <div className="flex gap-2">
                                {preAuthBuyOrder.isBot && preAuthBuyOrder.requiredXLM ? (
                                  <Button
                                    onClick={async () => {
                                      try {
                                        // XLM iade et
                                        setAutoTradeStatus('ğŸ’¸ XLM iade ediliyor...');
                                        const refundResult = await refundXLMFromBot(preAuthBuyOrder.requiredXLM!);
                                        
                                        if (refundResult.success) {
                                          setAutoTradeStatus(`âœ… ${preAuthBuyOrder.requiredXLM!.toFixed(2)} XLM iade edildi!`);
                                        }
                                        
                                        // Emri temizle
                                        setPreAuthBuyOrder(null);
                                        localStorage.removeItem(`preauth_buy_${publicKey}`);
                                        
                                        // Telegram bildirimi
                                        if (telegramBot && telegramChatId) {
                                          const message = `ğŸ¤– BOT ALIM EMRÄ° Ä°PTAL!
âŒ AlÄ±m emri iptal edildi
ğŸ’¸ ${preAuthBuyOrder.requiredXLM!.toFixed(2)} XLM iade edildi
â° ${new Date().toLocaleString('tr-TR')}`;
                                          
                                          await telegramBot.sendMessage(telegramChatId, message);
                                        }
                                        
                                      } catch (error) {
                                        setAutoTradeStatus(`âŒ Ä°ptal hatasÄ±: ${error}`);
                                      }
                                    }}
                                    size="sm"
                                    variant="error"
                                    className="flex-1"
                                    disabled={isTrading}
                                  >
                                    âŒ Ä°ptal + Ä°ade
                                  </Button>
                                ) : null}
                                <Button
                                  onClick={() => {
                                    setPreAuthBuyOrder(null);
                                    localStorage.removeItem(`preauth_buy_${publicKey}`);
                                    if (preAuthBuyOrder.isBot && preAuthBuyOrder.requiredXLM) {
                                      setAutoTradeStatus('âš ï¸ Emri iptal ettiniz. XLM iade etmek iÃ§in "âŒ Ä°ptal + Ä°ade" butonunu kullanÄ±n.');
                                    }
                                  }}
                                  size="sm"
                                  variant="error"
                                  className="flex-1"
                                >
                                  ğŸ—‘ï¸ {preAuthBuyOrder.isBot ? 'Sadece Sil' : 'Ä°ptal Et'}
                                </Button>
                              </div>
                            </div>
                          )}
                          
                          {preAuthBuyOrder && (
                            <div className="text-xs p-2 rounded bg-green-50 text-green-700">
                              <div className="whitespace-pre-line">{preAuthBuyOrder.status}</div>
                            </div>
                          )}
                        </div>
                      </div>
                    </div>

                    {/* SatÄ±m AyarlarÄ± */}
                    <div className="p-4 bg-red-50 rounded-lg border-2 border-red-200">
                      <h4 className="font-semibold text-red-800 mb-3">ğŸ’¸ Otomatik SatÄ±m</h4>
                      <div className="space-y-3">
                        <div>
                          <label className="block text-sm font-medium mb-1">Hedef Fiyat ($)</label>
                          <input
                            type="number"
                            step="0.0001"
                            placeholder="0.1400"
                            value={sellTargetPrice}
                            onChange={(e) => setSellTargetPrice(e.target.value)}
                            className="w-full px-3 py-2 border border-red-300 rounded"
                            disabled={isTrading || !isAutoTradingEnabled}
                          />
                          <p className="text-xs text-red-600 mt-1">
                            Fiyat â‰¥ Bu deÄŸerde sat
                          </p>
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">
                            Miktar ({ASSET_OPTIONS.find(a => a.value === autoTradeAssetIn)?.symbol})
                          </label>
                          <input
                            type="number"
                            min="1"
                            step="1"
                            placeholder="10"
                            value={autoSellAmount}
                            onChange={(e) => setAutoSellAmount(e.target.value)}
                            className="w-full px-3 py-2 border border-red-300 rounded"
                            disabled={isTrading || !isAutoTradingEnabled}
                          />
                        </div>
                        {sellTargetPrice && (
                          <div className={`text-sm p-2 rounded ${displayPrice >= parseFloat(sellTargetPrice) ? 'bg-red-200 text-red-800 font-bold' : 'bg-gray-100 text-gray-600'}`}>
                            {displayPrice >= parseFloat(sellTargetPrice) ? 'ğŸ¯ HEDEF ULAÅILDI!' : 'â³ Hedef bekleniyor...'}
                          </div>
                        )}
                        
                        {/* Pre-Authorization Buttons */}
                        <div className="space-y-2">
                          {!preAuthSellOrder ? (
                            <div className="space-y-2">
                              {/* Manuel Mod Butonu */}
                              <Button
                                onClick={() => createPreAuthSellOrder(false)}
                                disabled={!sellTargetPrice || !autoSellAmount || !isConnected}
                                size="sm"
                                variant="secondary"
                                className="w-full"
                              >
                                ğŸ‘¤ Manuel SatÄ±m Emri
                              </Button>
                              
                              {/* Bot Mod Butonu */}
                              {botMode === 'auto' && botWallet ? (
                                <Button
                                  onClick={() => createPreAuthSellOrder(true)}
                                  disabled={!sellTargetPrice || !autoSellAmount || !isConnected}
                                  size="sm"
                                  variant="error"
                                  className="w-full"
                                >
                                  ğŸ¤– Bot SatÄ±m Emri
                                </Button>
                              ) : (
                                <div className="text-xs bg-yellow-100 p-2 rounded text-yellow-700 border">
                                  âš ï¸ Bot modu iÃ§in &quot;ğŸ¤– Otomatik&quot; modunu seÃ§in ve bot wallet oluÅŸturun.
                                </div>
                              )}


                            </div>
                          ) : (
                            <div className="space-y-2">
                              <div className="text-xs bg-red-100 text-red-700 p-2 rounded border">
                                âœ… SatÄ±m emri hazÄ±r
                                <div className="text-xs mt-1">
                                  â° SÃ¼re: {Math.round((preAuthSellOrder.expiry.getTime() - Date.now()) / 60000)} dk kaldÄ±
                                </div>
                              </div>
                              <Button
                                onClick={() => {
                                  setPreAuthSellOrder(null);
                                  localStorage.removeItem(`preauth_sell_${publicKey}`);
                                }}
                                size="sm"
                                variant="error"
                                className="w-full"
                              >
                                âŒ Emri Ä°ptal
                              </Button>
                            </div>
                          )}
                          
                          {preAuthSellOrder && (
                            <div className="text-xs p-2 rounded bg-red-50 text-red-700">
                              <div className="whitespace-pre-line">{preAuthSellOrder.status}</div>
                            </div>
                          )}


                        </div>
                      </div>
                    </div>

                    {/* ğŸ¤– Grid Trading Bot */}
                    <div className="p-4 bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg border-2 border-purple-200">
                      <h4 className="font-semibold text-purple-800 mb-3">ğŸ¤– Grid Trading Bot (AlÄ±m + SatÄ±m)</h4>
                      <div className="text-xs text-purple-600 mb-3 p-2 bg-purple-50 rounded border">
                        ğŸ”„ <strong>Ä°ÅŸlem SÄ±rasÄ±:</strong> 1ï¸âƒ£ Ä°lk Ã¶nce ALIM (dÃ¼ÅŸÃ¼k fiyat, bot&apos;da tutuluyor) â†’ 2ï¸âƒ£ Sonra SATIM (yÃ¼ksek fiyat, kazanÃ§ ana cÃ¼zdana)
                      </div>
                      <div className="space-y-3">
                        <div className="grid grid-cols-2 gap-2">
                          <div>
                            <label className="block text-sm font-medium mb-1">AlÄ±m FiyatÄ± ($)</label>
                            <input
                              type="number"
                              step="0.0001"
                              placeholder="0.1300"
                              value={gridBuyPrice}
                              onChange={(e) => setGridBuyPrice(e.target.value)}
                              className="w-full px-2 py-2 border border-purple-300 rounded text-sm"
                              disabled={isTrading || (gridTradingBot?.isActive || false)}
                            />
                            <p className="text-xs text-purple-600 mt-1">
                              Fiyat â‰¤ Bu deÄŸerde al (eÅŸit ve altÄ±)
                            </p>
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-1">SatÄ±m FiyatÄ± ($)</label>
                            <input
                              type="number"
                              step="0.0001"
                              placeholder="0.1400"
                              value={gridSellPrice}
                              onChange={(e) => setGridSellPrice(e.target.value)}
                              className="w-full px-2 py-2 border border-purple-300 rounded text-sm"
                              disabled={isTrading || (gridTradingBot?.isActive || false)}
                            />
                            <p className="text-xs text-purple-600 mt-1">
                              Fiyat â‰¥ Bu deÄŸerde sat (eÅŸit ve Ã¼stÃ¼)
                            </p>
                          </div>
                        </div>
                        
                        <div>
                          <label className="block text-sm font-medium mb-1">Ä°ÅŸlem MiktarÄ±</label>
                          <input
                            type="number"
                            step="0.01"
                            placeholder="100"
                            value={gridAmount}
                            onChange={(e) => setGridAmount(e.target.value)}
                            className="w-full px-3 py-2 border border-purple-300 rounded"
                            disabled={isTrading || (gridTradingBot?.isActive || false)}
                          />
                        </div>

                        {gridBuyPrice && gridSellPrice && (
                          <div className="p-2 bg-purple-100 rounded text-xs">
                            <div className="text-purple-700">
                              ğŸ“ˆ Beklenen Kar OranÄ±: {gridBuyPrice && gridSellPrice ? 
                                ((parseFloat(gridSellPrice) - parseFloat(gridBuyPrice)) / parseFloat(gridBuyPrice) * 100).toFixed(2) : '0'}%
                            </div>
                            <div className="text-purple-600 mt-1">
                              ğŸ”„ Ä°ÅŸlem: ${gridBuyPrice}&apos;da al â†’ ${gridSellPrice}&apos;da sat
                            </div>
                          </div>
                        )}

                        <div className="grid grid-cols-2 gap-2">
                          {botMode === 'manual' ? (
                            <Button
                              onClick={() => createGridTradingBot(false)}
                              disabled={isTrading || !gridBuyPrice || !gridSellPrice || !gridAmount || 
                                       (gridTradingBot?.isActive || false)}
                              variant="primary"
                              size="sm"
                              className="w-full"
                            >
                              ğŸ‘¤ Manuel Grid Bot
                            </Button>
                          ) : (
                            <Button
                              onClick={() => createGridTradingBot(true)}
                              disabled={isTrading || !gridBuyPrice || !gridSellPrice || !gridAmount || 
                                       !botWallet || (gridTradingBot?.isActive || false)}
                              variant="secondary"
                              size="sm"
                              className="w-full"
                            >
                              ğŸ¤– Otomatik Grid Bot
                            </Button>
                          )}
                          
                          {gridTradingBot?.isActive && (
                            <Button
                              onClick={() => {
                                setGridTradingBot(null);
                                localStorage.removeItem(`grid_bot_${publicKey}`);
                                setAutoTradeStatus('âŒ Grid trading bot durduruldu.');
                              }}
                              variant="error"
                              size="sm"
                              className="w-full"
                            >
                              âŒ Bot&apos;u Durdur
                            </Button>
                          )}
                        </div>
                          
                        {gridTradingBot && (
                          <div className="text-xs p-2 rounded bg-purple-50 text-purple-700">
                            <div className="whitespace-pre-line">{gridTradingBot.status}</div>
                            <div className="mt-2 text-purple-600">
                              ğŸ”„ Ä°ÅŸlem AÅŸamasÄ±: {
                                gridTradingBot.currentStep === 'waiting_buy' ? '1ï¸âƒ£ AlÄ±m Bekleniyor (Ä°lk AÅŸama)' : 
                                gridTradingBot.currentStep === 'waiting_sell' ? '2ï¸âƒ£ SatÄ±m Bekleniyor (AlÄ±m TamamlandÄ±)' : 
                                'âœ… DÃ¶ngÃ¼ TamamlandÄ±'
                              }
                            </div>
                            {gridTradingBot.currentStep === 'waiting_buy' && (
                              <div className="text-purple-600 text-xs mt-1">
                                ğŸ“Š Hedef: Fiyat ${gridTradingBot.buyPrice} veya altÄ±na dÃ¼ÅŸtÃ¼ÄŸÃ¼nde alÄ±m yapÄ±lacak
                              </div>
                            )}
                            {gridTradingBot.currentStep === 'waiting_sell' && (
                              <div className="text-purple-600 text-xs mt-1">
                                ğŸ“Š Hedef: Fiyat ${gridTradingBot.sellPrice} veya Ã¼stÃ¼ne Ã§Ä±ktÄ±ÄŸÄ±nda satÄ±m yapÄ±lacak
                              </div>
                            )}
                            {gridTradingBot.expiry && (
                              <div className="text-purple-500 text-xs mt-1">
                                â° Kalan SÃ¼re: {Math.round((gridTradingBot.expiry.getTime() - Date.now()) / (1000 * 60))} dakika
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    </div>
                  </div>

                  {/* HÄ±zlÄ± Test ButonlarÄ± */}
                  <div className="grid grid-cols-2 gap-4">
                    <Button
                      onClick={() => {
                        const testPrice = (currentPrice * 0.995).toFixed(4);
                        setBuyTargetPrice(testPrice);
                        setAutoBuyAmount('1');
                        setIsAutoTradingEnabled(true);
                      }}
                      size="sm"
                      variant="success"
                      disabled={currentPrice === 0}
                    >
                      ğŸ§ª Test AlÄ±m (-0.5%)
                    </Button>
                    <Button
                      onClick={() => {
                        const testPrice = (currentPrice * 1.005).toFixed(4);
                        setSellTargetPrice(testPrice);
                        setAutoSellAmount('1');
                        setIsAutoTradingEnabled(true);
                      }}
                      size="sm"
                      variant="error"
                      disabled={currentPrice === 0}
                    >
                      ğŸ§ª Test SatÄ±m (+0.5%)
                    </Button>
                  </div>

                  {/* Durum Paneli */}
                  <div className="p-4 bg-white rounded-lg border-2 border-gray-200">
                    <h4 className="font-semibold mb-3">ğŸ“Š Sistem Durumu</h4>
                    <div className="grid grid-cols-2 gap-4 text-sm">
                      <div>
                        <div className="text-gray-600">GÃ¼ncel Fiyat:</div>
                        <div className="font-mono text-lg font-bold">${displayPrice.toFixed(4)}</div>
                      </div>
                      <div>
                        <div className="text-gray-600">Sistem Durumu:</div>
                        <div className={`font-medium ${
                          hasAutoTradeError ? 'text-red-600' :
                          isTrading ? 'text-orange-600' :
                          isAutoTradingEnabled ? 'text-green-600' : 'text-gray-600'
                        }`}>
                          {hasAutoTradeError ? 'ğŸš¨ Hata' : 
                           isTrading ? 'â³ Ä°ÅŸlem YapÄ±yor' :
                           isAutoTradingEnabled ? 'ğŸŸ¢ Aktif Bekliyor' : 'âšª Pasif'}
                        </div>
                      </div>
                    </div>
                    
                    {/* Pre-Auth Status */}
                    <div className="mt-4 grid grid-cols-2 gap-4 text-xs">
                      <div>
                        <div className="text-gray-600">Pre-Auth AlÄ±m:</div>
                        <div className={`font-medium ${preAuthBuyOrder ? 'text-green-600' : 'text-gray-400'}`}>
                          {preAuthBuyOrder ? 'âœ… HazÄ±r' : 'âšª Yok'}
                        </div>
                      </div>
                      <div>
                        <div className="text-gray-600">Pre-Auth SatÄ±m:</div>
                        <div className={`font-medium ${preAuthSellOrder ? 'text-red-600' : 'text-gray-400'}`}>
                          {preAuthSellOrder ? 'âœ… HazÄ±r' : 'âšª Yok'}
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Durum MesajÄ± */}
                  {autoTradeStatus && (
                    <div className={`text-sm p-4 rounded-lg border-2 ${
                      autoTradeStatus.startsWith('âœ…') ? 'bg-green-50 border-green-200 text-green-700' :
                      autoTradeStatus.startsWith('âŒ') ? 'bg-red-50 border-red-200 text-red-700' :
                      autoTradeStatus.startsWith('ğŸ¯') ? 'bg-blue-50 border-blue-200 text-blue-700' :
                      'bg-yellow-50 border-yellow-200 text-yellow-700'
                    }`}>
                      <div className="whitespace-pre-line font-medium">{autoTradeStatus}</div>
                    </div>
                  )}
                </div>
              ) : (
                <div className="text-center py-8">
                  <div className="text-gray-500 mb-4">ğŸ¤– Bot trading iÃ§in Freighter wallet baÄŸlantÄ±sÄ± gerekli</div>
                  <Button onClick={connectWallet} disabled={!isAvailable} variant="success" className="mb-3">
                    ğŸ”— Freighter&apos;a BaÄŸlan
                  </Button>
                  <div className="text-xs text-yellow-700 bg-yellow-100 p-3 rounded border mx-4">
                    âš ï¸ <strong>localhost baÄŸlantÄ± sorunu?</strong><br/>
                    EÄŸer &quot;domain not connected&quot; hatasÄ± alÄ±yorsanÄ±z yukarÄ±daki butona basÄ±n.
                  </div>
                </div>
              )}
            </Card>
          </div>
        </div>

        {/* Bot Trading AÃ§Ä±klamasÄ± */}
        <Card title="ğŸ“˜ Ä°kili Mod Sistemi NasÄ±l Ã‡alÄ±ÅŸÄ±r?" className="bg-green-50 border-green-200">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
            <div>
              <h4 className="font-semibold mb-3 text-green-800">ğŸ‘¤ Manuel Mod</h4>
              <ul className="space-y-2 text-green-700">
                <li>â€¢ <strong>1. Pre-Auth:</strong> &quot;ğŸ‘¤ Manuel AlÄ±m Emri&quot; butonuna basÄ±n</li>
                <li>â€¢ <strong>2. Takip:</strong> Bot fiyat takibi yapar</li>
                <li>â€¢ <strong>3. Tetikleme:</strong> Hedef fiyatta alert + popup</li>
                <li>â€¢ <strong>4. Ä°mza:</strong> Freighter aÃ§Ä±lÄ±r, iÅŸlemi imzalarsÄ±nÄ±z</li>
                <li>â€¢ <strong>5. Para:</strong> Ana cÃ¼zdanÄ±nÄ±zdan Ã§Ä±kar</li>
                <li>â€¢ <strong>6. Ä°ptal:</strong> &quot;ğŸ—‘ï¸ Ä°ptal Et&quot; ile iptal</li>
              </ul>
              <div className="mt-3 p-2 bg-blue-100 rounded text-blue-700">
                ğŸ’¡ <strong>Manuel mod:</strong> PC baÅŸÄ±nda deÄŸilseniz iÅŸlem yapÄ±lmaz.
              </div>
            </div>
            <div>
              <h4 className="font-semibold mb-3 text-green-800">ğŸ¤– Bot Mod (Otomatik Transfer)</h4>
              <ul className="space-y-2 text-green-700">
                <li>â€¢ <strong>1. HazÄ±rlÄ±k:</strong> Bot modu seÃ§in ve bot wallet oluÅŸturun</li>
                <li>â€¢ <strong>2. Transfer:</strong> &quot;ğŸ¤– Bot AlÄ±m Emri&quot; butonuna basÄ±n</li>
                <li>â€¢ <strong>3. Freighter:</strong> Gerekli XLM&apos;i bot wallet&apos;a transfer eder</li>
                <li>â€¢ <strong>4. Takip:</strong> Bot fiyat takibi yapar</li>
                <li>â€¢ <strong>5. Otomatik:</strong> Hedef fiyatta bot otomatik iÅŸlem yapar</li>
                <li>â€¢ <strong>6. Ä°ptal:</strong> &quot;âŒ Ä°ptal + Ä°ade&quot; ile XLM geri alÄ±n</li>
              </ul>
              <div className="mt-3 p-2 bg-orange-100 rounded text-orange-700">
                ğŸš€ <strong>Bot mod:</strong> PC baÅŸÄ±nda olmadÄ±ÄŸÄ±nÄ±zda bile iÅŸlem yapar!
              </div>
            </div>
          </div>
          
          <div className="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div className="p-3 bg-blue-50 rounded border-l-4 border-blue-400">
              <h5 className="font-semibold text-blue-800 mb-2">Manuel Mod Ne Zaman KullanÄ±lÄ±r?</h5>
              <ul className="text-blue-700 text-sm space-y-1">
                <li>â€¢ PC baÅŸÄ±nda olacaksÄ±nÄ±z</li>
                <li>â€¢ Ä°ÅŸlemi kendiniz kontrol etmek istiyorsunuz</li>
                <li>â€¢ Ãœcreti Ã¶nceden Ã¶demek istemiyorsunuz</li>
              </ul>
            </div>
            <div className="p-3 bg-orange-50 rounded border-l-4 border-orange-400">
              <h5 className="font-semibold text-orange-800 mb-2">Bot Mod Ne Zaman KullanÄ±lÄ±r?</h5>
              <ul className="text-orange-700 text-sm space-y-1">
                <li>â€¢ PC baÅŸÄ±nda olmayacaksÄ±nÄ±z</li>
                <li>â€¢ Tam otomasyon istiyorsunuz</li>
                <li>â€¢ Ã–nceden Ã¼cret Ã¶deyebilirsiniz</li>
              </ul>
            </div>
          </div>
        </Card>

        {/* Ã–nemli Notlar */}
        <Card title="âš ï¸ Ä°kili Mod Sistemi NotlarÄ±" className="bg-yellow-50 border-yellow-200">
          <div className="text-sm space-y-2 text-yellow-800">
            <p><strong>ğŸ¯ Ä°ki AyrÄ± Mod:</strong></p>
            <p><strong>ğŸ‘¤ Manuel Mod:</strong> Ana cÃ¼zdanÄ±nÄ±zdan para Ã§Ä±kar, her iÅŸlemde imza gerekir, PC baÅŸÄ±nda olmanÄ±z gerekli.</p>
            <p><strong>ğŸ¤– Bot Mod:</strong> AlÄ±m onayÄ±nda Freighter ile XLM otomatik transfer, bot sizin adÄ±nÄ±za iÅŸlem yapar, PC baÅŸÄ±nda olmanÄ±z gerekmez.</p>
            <p><strong>ï¿½ Freighter Transfer:</strong> &quot;AlÄ±m Emri OnayÄ± (Freighter Transfer)&quot; butonuna basÄ±nca Freighter aÃ§Ä±lÄ±r ve otomatik transfer.</p>
            <p><strong>ğŸ’¸ Token Transfer:</strong> Ä°ÅŸlem sonrasÄ± aldÄ±ÄŸÄ±nÄ±z token&apos;lar (USDC, XSTAR vs.) belirttiÄŸiniz adrese otomatik gÃ¶nderilir.</p>
            <p><strong>ğŸ¯ AkÄ±llÄ± Transfer:</strong> Bot tam olarak aldÄ±ÄŸÄ±nÄ±z asset tÃ¼rÃ¼nÃ¼ (USDC, XSTAR, vs.) size gÃ¶nderir.</p>
            <p><strong>âŒ Ä°ptal ve Ä°ade:</strong> Emri iptal ederseniz &quot;âŒ Ä°ptal + Ä°ade&quot; ile XLM&apos;iniz iade edilir.</p>
            <p><strong>â° GeÃ§erlilik:</strong> Pre-auth emirleri 2 saat geÃ§erlidir.</p>
            <p><strong>ğŸ’° Test:</strong> KÃ¼Ã§Ã¼k miktarlarla test yapmanÄ±z Ã¶nerilir.</p>
            <p><strong>ğŸ“± Bildirim:</strong> Ä°ÅŸlem, transfer ve iptal iÅŸlemleri Telegram&apos;dan bildirilir.</p>
            <p><strong>ğŸ” GÃ¼venlik:</strong> Bot secret key&apos;i kimseyle paylaÅŸmayÄ±n!</p>
          </div>
        </Card>

        </>
        )}
      </div>
    </div>
  );
}
